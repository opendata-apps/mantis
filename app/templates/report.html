{% extends "layout.html" %}
{% from "macro.html" import popover %}
{% block head %}
<script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
{% endblock %}
{% block title %}Report{% endblock %}
{% block content %}
{% with messages = get_flashed_messages() %}
{% if messages %}
{% for message in messages %}
<div id="toast-interactive-{{ loop.index }}"
  class="fixed z-50 max-w-2xl px-4 py-2 text-gray-500 transform -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg shadow toast dark:bg-gray-800 dark:text-gray-400 top-1/4 left-1/2 min-h-16"
  role="alert">
  <div class="flex">
    <div
      class="inline-flex items-center justify-center flex-shrink-0 w-8 h-8 text-green-500 bg-green-100 rounded-lg dark:text-green-300 dark:bg-green-900">
      <span class="sr-only">Notification icon</span>
    </div>
    <div class="ml-3 text-sm font-normal">
      <p class="mb-1 text-sm font-semibold text-gray-900 break-all dark:text-white">{{ message.title }}</p>
      <p class="text-gray-800 dark:text-gray-400">{{ message.message }}</p>
      <pre class="overflow-x-auto font-mono text-xs text-gray-800 dark:text-gray-400">{{ message.usrid }}</pre>
      <div class="grid grid-cols-2 gap-2 mt-2">
        <div>
          <a href="/report"
            class="inline-flex justify-center w-full px-2 py-1.5 text-xs font-medium text-center text-white bg-green-600 rounded-lg hover:bg-green-700 focus:ring-4 focus:outline-none focus:ring-blue-300 ">Report
            Mantis</a>
        </div>
        <div>
          <button onclick="copyToClipboard('{{ message.usrid }}')" title="Copy User ID"
            class="inline-flex justify-center w-full px-2 py-1.5 text-xs font-medium text-center text-gray-900 bg-white border border-gray-300 rounded-lg hover:bg-gray-100 focus:ring-4 focus:outline-none focus:ring-gray-200 ">Copy
            ID</button>
        </div>
      </div>
    </div>
    <button type="button"
      class="ml-auto -mx-1.5 -my-1.5 bg-white text-gray-400 hover:text-gray-900 rounded-lg focus:ring-2 focus:ring-gray-300 p-1.5 hover:bg-gray-100 inline-flex h-8 w-8 "
      data-dismiss-target="#toast-interactive-{{ loop.index }}" aria-label="Close">
      <span class="sr-only">Close</span>
      <svg aria-hidden="true" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"
        xmlns="http://www.w3.org/2000/svg">
        <path fill-rule="evenodd"
          d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
          clip-rule="evenodd"></path>
      </svg>
    </button>
  </div>
</div>
{% endfor %}
{% endif %}
{% endwith %}





<div class="flex items-center min-h-screen bg-gray-100">
  <div class="w-full max-w-4xl p-6 mx-auto bg-white rounded-lg shadow-xl">
    <form action="" method="POST" enctype="multipart/form-data" id="mainForm">
      {{ form.hidden_tag() }}
      {{ form.csrf_token }}
      <!-- User Input and Location Input Step Start-->
      <div id="step1" class="step">
        {{ form.hidden_tag() }}
        <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
          <div>
            <div class="flex justify-between">
              {{ form.picture.label.text }}
              {{ popover("popover-picture", "Info zum Bild-Upload",
              "Anhand des Bildes können wir Ihre Bestimmung überprüfen. Ist Ihr Fund von uns überprüft und
              freigegeben,
              erscheint er in der Karte. Die Bilder werden nicht weiterverwendet. Ihre Urheberrechte bleiben
              unberührt.") }}
            </div>
            <div class="relative">
              {{ form.picture(class="block w-full mt-1 text-sm text-gray-900 border border-gray-300 rounded-lg
              cursor-pointer bg-gray-50 focus:outline-none ",
              id=form.picture.id, accept="image/*", capture="user")
              }}
            </div>
            <p class="mt-1 text-sm text-gray-500" id="{{ form.picture.id }}_help">
              {{ form.picture.description }}
            </p>
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-600">
              <div class="flex justify-between">
                {{ form.gender.label.text }}
                {{ popover("popover-gender", "Entwicklungsstadium",
                'Dieses Feld ist eine kleine Herausforderung für den Melder. Trauen Sie sich zu, das Geschlecht oder
                das
                Entwicklungsstadium zu bestimmen? Die Merkmale für die Bestimmung sind auf der folgender Seite genau
                beschrieben In jedem Fall werden Sie nach einer Bewertung
                durch Fachleute über das Ergebnis informiert.
                Versuchen Sie es!', '/bestimmung', 'Hilfe zur Bestimmung') }}
              </div>
              <div class="relative">
                {{ form.gender(class="w-full p-2 mt-1 bg-white border rounded-md focus:outline-none focus:ring-1
                focus:ring-green-500") }}
              </div>
            </label>
          </div>
          <div>
            <label class="text-sm font-semibold text-gray-600">
              <div class="flex justify-between">
                <div>{{ form.longitude.label.text }}</div>
                {{ popover("popover-longitude", "Koordinaten",
                "Der Längengrad wird automatisch angegeben, sobald Sie den Marker an der untenstehenden Karte
                setzen.")
                }}
              </div>
              <div class="relative">
                {{ form.longitude(placeholder="z.B. 13.12345",
                class="w-full p-2 mt-1 bg-white border rounded-md focus:outline-none focus:ring-1 focus:ring-green-500")
                }}
              </div>
            </label>
            <label class="block text-sm font-semibold text-gray-600">
              <div class="flex justify-between">
                {{ form.latitude.label.text }}
                {{ popover("popover-latitude", "Koordinaten",
                "Der Breitengrad wird automatisch angegeben, sobald Sie den Marker an der untenstehenden Karte
                setzen.")
                }}
              </div>
              <div class="relative">
                {{ form.latitude(placeholder="z.B. 52.12345",
                class="w-full p-2 mt-1 bg-white border rounded-md focus:outline-none focus:ring-1 focus:ring-green-500")
                }}
              </div>
            </label>
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-600">
              <div class="flex justify-between">
                {{ form.zip_code.label.text }}
                {{ popover("popover-zip", "Postleitzahl",
                "Falls der Wert nicht korrekt eingelesen wurde, geben Sie bitte die Postleitzahl ein.") }}
              </div>
              <div class="relative">
                {{ form.zip_code(id="zip_code",
                placeholder="z.B. 10115",
                class="w-full p-2 mt-1 bg-white border rounded-md focus:outline-none focus:ring-1 focus:ring-green-500")
                }}
              </div>
            </label>
            <label class="block text-sm font-semibold text-gray-600">
              <div class="flex justify-between">
                {{ form.city.label.text }}
                {{ popover("popover-city", "Ort",
                "Falls der Wert nicht korrekt eingelesen wurde, geben Sie bitte den Stadtnamen ein.") }}
              </div>
              <div class="relative">
                {{ form.city(id="city",
                placeholder="z.B. Berlin",
                class="w-full p-2 mt-1 bg-white border rounded-md focus:outline-none focus:ring-1 focus:ring-green-500")
                }}
              </div>
            </label>
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-600">
              <div class="flex justify-between">
                {{ form.street.label.text }}
                {{ popover("popover-street", "Straße",
                "Falls der Wert nicht korrekt eingelesen wurde, geben Sie bitte den Straßennamen ein.") }}
              </div>
              <div class="relative">
                {{ form.street(placeholder="z.B. Musterstraße",
                class="w-full p-2 mt-1 bg-white border rounded-md focus:outline-none focus:ring-1 focus:ring-green-500")
                }}
              </div>
            </label>
            <label class="block text-sm font-semibold text-gray-600">
              <div class="flex justify-between">
                {{ form.state.label.text }}
                {{ popover("popover-bundesland", "Bundesland",
                "Falls der Wert nicht korrekt eingelesen wurde, ergänzen Sie bitte den Namen des Bundeslandes.") }}
              </div>
              <div class="relative">
                {{ form.state(id="state",
                placeholder="z.B. Berlin",
                class="w-full p-2 mt-1 bg-white border rounded-md focus:outline-none focus:ring-1 focus:ring-green-500")
                }}
              </div>
            </label>
            <label class="block text-sm font-semibold text-gray-600">
              <div class="flex justify-between">
                {{ form.district.label.text }}
                {{ popover("popover-bezirk", "Landkreis/Stadt",
                "Falls der Wert nicht korrekt eingelesen wurde, geben Sie bitte den Landkreis/die Stadt ein.") }}
              </div>
              <div class="relative">
                {{ form.district(id="district",
                placeholder="z.B. Mitte",
                class="w-full p-2 mt-1 bg-white border rounded-md focus:outline-none focus:ring-1 focus:ring-green-500")
                }}
              </div>
            </label>
          </div>
          <div>
            <div class="flex justify-between">
              {{ form.picture_description.label.text }}
              {{ popover("popover-beschreibung", "Ergänzungen zum Fund",
              "Ergänzende Angaben zum Bild (maximal 500 Zeichen)") }}
            </div>
            <div class="relative">
              {{ form.picture_description(placeholder="Geben Sie hier Ihre Bildbeschreibung ein",
              class="w-full p-2 mt-1 whitespace-pre-wrap bg-white border rounded-md focus:outline-none focus:ring-1
              focus:ring-green-500") }}
            </div>
            <span id="charCount" class="text-xs text-right text-gray-500"></span>

            <div>
              <div class="flex justify-between">
                {{ form.location_description.label.text }}
                {{ popover("popover-fundort", "Ergänzungen Ort",
                "Beschreiben Sie hier bitte den Ort etwas genauer (maximal 500 Zeichen)") }}
              </div>
              <div class="relative">
                {{ form.location_description(placeholder="Geben Sie hier Ihre Ortsbeschreibung ein",
                class="w-full p-2 mt-1 whitespace-pre-wrap bg-white border rounded-md focus:outline-none focus:ring-1
                focus:ring-green-500") }}
              </div>
            </div>
          </div>
        </div>
        <div class="col-span-full">
          <div id="map" class="h-64 border shadow-md sm:h-96 lg:h-96">
          </div>
        </div>
        <div class="flex justify-end mt-4 space-x-2">
          <button type="button" id="step1Next"
            class="w-full px-6 py-2 text-sm font-medium leading-5 text-center text-white transition-colors duration-150 bg-green-500 border border-transparent rounded-lg hover:bg-green-600 focus:outline-none md:w-auto">
            Next
          </button>
        </div>
      </div>
      <!-- User Input and Location Input Step End-->

      <!-- Melderinfo Step Start-->
      <div id="step3" class="hidden step">
        <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
          <div>
            <label class="block text-sm font-semibold text-gray-600">
              <div class="flex justify-between">
                {{ form.report_first_name.label.text }}
                {{ popover("popover-reportvorname", "Vorname",
                "Geben Sie bitte Ihren ersten Buchstaben des Vornamens ein. Beispiel: M. für Max") }}
              </div>
              <div class="relative">
                {{ form.report_first_name(placeholder="Erster Buchstabe z.B. M.",
                class="w-full p-2 mt-1 bg-white border rounded-md focus:outline-none focus:ring-1 focus:ring-green-500")
                }}
              </div>
            </label>

            <label class="block text-sm font-semibold text-gray-600">
              <div class="flex justify-between">
                {{ form.report_last_name.label.text }}
                {{ popover("popover-reportnachname", "Nachname",
                "Geben Sie hier bitte Ihren Nachnamen ein.") }}
              </div>
              <div class="relative">
                {{ form.report_last_name(placeholder="z.B. Mustermann",
                class="w-full p-2 mt-1 bg-white border rounded-md focus:outline-none focus:ring-1 focus:ring-green-500")
                }}
              </div>
            </label>
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-600">
              <div class="flex justify-between">
                {{ form.sighting_date.label.text }}
                {{ popover("popover-datum", "Datum",
                "Wählen Sie hier bitte das Funddatum.") }}
              </div>
              <div class="relative">
                {{ form.sighting_date(placeholder="z.B. 2023-05-14",
                class="w-full p-2 mt-1 bg-white border rounded-md focus:outline-none focus:ring-green-500") }}
              </div>
            </label>
            <label class="block text-sm font-semibold text-gray-600">
              <div class="flex justify-between">
                {{ form.contact.label.text }}
                {{ popover("popover-kontakt", "Kontaktdaten",
                "Möchten Sie eine Rückmeldung und eine Bestätigung Ihrer Bestimmung erhalten, hinterlassen Sie gerne
                Ihre E-Mail. Ihre Kontaktdaten werden geschützt, nicht weitergegeben oder anderweitig verwendet.") }}
              </div>
              <div class="relative">
                {{ form.contact(placeholder="z.B. max@example.de",
                class="w-full p-2 mt-1 bg-white border rounded-md focus:outline-none focus:ring-1 focus:ring-green-500")
                }}
              </div>
            </label>
          </div>
        </div>

        <div class="flex justify-between mt-4 space-x-2">
          <button type="button" id="step2Prev"
            class="w-full px-6 py-2 text-sm font-medium leading-5 text-center text-white transition-colors duration-150 bg-green-500 border border-transparent rounded-lg hover:bg-green-600 focus:outline-none md:w-auto">
            Prev
          </button>
          <form>
            {{ form.submit(class="w-full px-6 py-2 text-sm font-medium leading-5 text-center text-white
            transition-colors duration-150 bg-green-500 border border-transparent rounded-lg hover:bg-green-600
            focus:outline-none md:w-auto") }}
          </form>
        </div>
      </div>
      <!-- Melderinfo Step End-->
    </form>
  </div>
</div>

<script>


  let map;
  // Add Leaflet map configuration and event handling
  function initMap() {
    map = L.map('map').setView([52.5200, 13.4050], 5);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      maxZoom: 18,
    }).addTo(map);

    let userMarker;

    // Update form fields on map click
    map.on('click', function (e) {
      document.querySelector('#latitude').value = e.latlng.lat.toFixed(5);
      document.querySelector('#longitude').value = e.latlng.lng.toFixed(5);

      getAddressFromCoordinates(e.latlng.lat, e.latlng.lng);

      if (userMarker) {
        userMarker.remove();
      }

      userMarker = L.marker([e.latlng.lat, e.latlng.lng]).addTo(map);
    });
  }
  document.addEventListener('DOMContentLoaded', initMap);

  function getAddressFromCoordinates(latitude, longitude) {
    const nominatimUrl = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&zoom=18&addressdetails=1`;

    fetch(nominatimUrl)
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        const address = data.address;

        document.querySelector("#zip_code").value = address.postcode ? address.postcode.split(";")[0] : "";
        document.querySelector("#city").value = address.city || address.town || address.village || "";
        document.querySelector("#street").value = `${address.road || ""} ${address.house_number || ""}`.trim();
        document.querySelector("#state").value = address.state || address.city || "";
        document.querySelector("#district").value = address.county || address.suburb || address.borough || "";

        console.log("Returned data:", data);
      })
      .catch(error => {
        console.error("Error fetching address data:", error);
      });
  }

  // Use Jinja2 to pass the Python variables to JavaScript
  let existing_user = {{ existing_user | tojson | safe }};

  // Check if the existing_user is not null
  if (existing_user) {
    // Prefill and lock the fields
    document.getElementById("report_first_name").value = existing_user.user_name.split(" ")[1];
    document.getElementById("report_last_name").value = existing_user.user_name.split(" ")[0];
    document.getElementById("contact").value = existing_user.user_kontakt;

    // Make the fields readonly
    document.getElementById("report_first_name").readOnly = true;
    document.getElementById("report_last_name").readOnly = true;
    document.getElementById("contact").readOnly = true;
  }


  function saveFormDataToLocalStorage() {
    const form = document.getElementById('mainForm');
    const formData = new FormData(form);

    for (const [key, value] of formData.entries()) {
      if (key !== "csrf_token") { // exclude csrf_token
        localStorage.setItem(key, value);
      }
    }
  }

  function loadFormDataFromLocalStorage() {
    const form = document.getElementById('mainForm');

    for (const input of form.elements) {
      if (input.name && input.type !== 'file') {
        const value = localStorage.getItem(input.name);
        if (value) {
          try {
            input.value = value;
          } catch (e) {
            console.error('Error setting input value:', e);
          }
        }
      }
    }
  }


  // Call this function when the page loads to load saved form data.
  document.addEventListener('DOMContentLoaded', loadFormDataFromLocalStorage);

  // Call this function to save form data to local storage when any input changes.
  document.getElementById('mainForm').addEventListener('input', saveFormDataToLocalStorage);

  document.addEventListener('DOMContentLoaded', function () {
    const pictureInput = document.querySelector('#picture');

    pictureInput.addEventListener('change', function (event) {
      const file = event.target.files[0];
      if (!file) return;

      EXIF.getData(file, function () {
        // Read metadata from the image
        const lat = EXIF.getTag(this, 'GPSLatitude');
        const lng = EXIF.getTag(this, 'GPSLongitude');
        const latRef = EXIF.getTag(this, 'GPSLatitudeRef');
        const lngRef = EXIF.getTag(this, 'GPSLongitudeRef');

        if (lat && lng && latRef && lngRef) {
          // Convert coordinates to decimal
          const latitude = toDecimal(lat, latRef);
          const longitude = toDecimal(lng, lngRef);

          // Set the values to the form fields
          document.querySelector('#latitude').value = latitude;
          document.querySelector('#longitude').value = longitude;
          console.log('Latitude: ' + latitude + ' Longitude: ' + longitude);

          getAddressFromCoordinates(latitude, longitude);
        } else {
          // Handle the case when GPS data is not available in the image
          console.log('No GPS data found in the file');
        }
      });
    });
  });

  function toDecimal(coord, ref) {
    const [degrees, minutes, seconds] = coord;
    let decimal = degrees + minutes / 60 + seconds / (60 * 60);

    if (ref === 'S' || ref === 'W') {
      decimal = -decimal;
    }

    return decimal;
  }

  const steps = document.querySelectorAll('.step');
  const step1Next = document.getElementById('step1Next');
  const step2Prev = document.getElementById('step2Prev');

  function showStep(index) {
    steps.forEach((step, i) => {
      step.classList.toggle('hidden', i !== index);
    });

    // When showing the map, invalidate the size and slightly delay the map resize
    if (index === 1) {
      setTimeout(() => {
        map.invalidateSize();
      }, 100);
    }
  }

  step1Next.addEventListener('click', () => showStep(1));
  step2Prev.addEventListener('click', () => showStep(0));

  function autoCompleteData(inputField, zipCode, city, district, state) {
    var inputs = ['zip_code', 'city', 'district', 'state'];

    for (const id of inputs) {
      if (inputField.id === id) continue;
      let fieldValue = null;

      switch (id) {
        case 'zip_code':
          fieldValue = zipCode;
          break;
        case 'city':
          fieldValue = city;
          break;
        case 'district':
          fieldValue = district;
          break;
        case 'state':
          fieldValue = state;
          break;
      }

      document.getElementById(id).value = fieldValue || '';
    }
  }

  function getAutoCompleteData(inputField) {
    var query = inputField.value;
    if (query) {
      fetch('/autocomplete?q=' + query)
        .then(response => response.json())
        .then(data => {
          if (data.length > 0) {
            var firstResult = data[0];
            autoCompleteData(inputField, firstResult.plz, firstResult.ort, firstResult.landkreis, firstResult.bundesland);
          }
        });
    }
  }

  document.addEventListener('DOMContentLoaded', function () {
    var zipCodeInput = document.getElementById('zip_code');

    function addEvents(inputField) {
      inputField.addEventListener('keydown', function (event) {
        if (event.key === 'Enter' || event.key === 'Tab') {
          if (inputField.value.length >= 4) {
            getAutoCompleteData(inputField);
          }
        }
      });
      inputField.addEventListener('blur', function () {
        if (inputField.value.length >= 5) {
          getAutoCompleteData(inputField);
        }
      });
      //if input field is empty, clear all other fields related to it
      inputField.addEventListener('input', function () {
        if (inputField.value === '') {
          autoCompleteData(inputField, '', '', '', '');
        }
      });
    }

    addEvents(zipCodeInput);
  });

  // Character Counter for Picture Description on load
  const inputField = document.querySelector("#{{ form.picture_description.id }}");
  const charCountElement = document.querySelector("#charCount");

  function updateCharCount() {
    const charCount = inputField.value.length;
    charCountElement.textContent = `(${charCount}/500)`;
  }

  inputField.addEventListener("input", updateCharCount);

  // Display counter on load
  updateCharCount();
  // Character Counter for Picture Description

  // Step 1 Validation
  const GENDER_CHOICES = [
    ['', 'Bitte auswählen'],
    ['keine Zuoordnung', 'Keine Zuordnung']
    ['männchen', 'Männchen'],
    ['weibchen', 'Weibchen'],
    ['nymphen', 'Nymphen'],
    ['ootheken', 'Ootheken']
  ];

  const ALLOWED_EXTENSIONS = ['png', 'jpg', 'jpeg', 'jfif', 'webp'];

  function validateStep1() {
    const picture = document.querySelector('#picture').files[0];
    const allowedTypes = ['png', 'jpg', 'jpeg', 'jfif', 'webp'];
    const allowedSize = 5 * 1024 * 1024;
    const fileName = picture ? picture.name.toLowerCase() : '';

    // Überprüfen, ob das Bildfeld ausgefüllt wurde und eine gültige Datei ausgewählt wurde
    if (!picture) {
      alert('Bitte wählen Sie ein Bild aus.');
      return false;
    } else if (!allowedTypes.includes(fileName.split('.').pop()) || picture.size > allowedSize) {
      alert('Bitte geben Sie eine gültige Bilddatei ein, die kleiner als 5 MB ist und eine der folgenden Erweiterungen hat: PNG, JPG, JPEG oder GIF.')
      return false;
    } else {
      const gender = document.querySelector('#gender').value;

      // Überprüfen, ob das Geschlecht ausgefüllt wurde und ob es ein gültiger Wert ist
      if (gender === '') {
        alert('Bitte wählen Sie ein Entwicklungsstadium aus.');
        return false;
      }

      return true;
    }
  }
  // Ändern Sie den Event-Listener, um die Pflichtfeldüberprüfung durchzuführen
  step1Next.addEventListener('click', () => {
    if (validateStep1()) {
      showStep(1);
    }
  });

  function copyToClipboard(id) {
    if (id) {
      var tempInput = document.createElement("input");
      tempInput.value = id;
      document.body.appendChild(tempInput);
      tempInput.select();
      document.execCommand("copy");
      document.body.removeChild(tempInput);
      // Show a success toast or something
    }
    else {
      console.error("No ID provided: " + id);
    }
  }


</script>
</div>
</div>
</body>

{% endblock content %}