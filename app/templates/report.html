{% extends "layout.html" %}
{% from "macro.html" import popover with context %}
{% from "macro.html" import formButton %}
{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='node_modules/leaflet/dist/leaflet.css')}}" />
<link rel="stylesheet" href="{{ url_for('static', filename='node_modules/leaflet.markercluster/dist/MarkerCluster.css')}}" />
<link rel="stylesheet" href="{{ url_for('static', filename='node_modules/leaflet.markercluster/dist/MarkerCluster.Default.css')}}" />
<link rel="stylesheet" href="{{ url_for('static', filename='node_modules/leaflet.locatecontrol/dist/L.Control.Locate.min.css')}}" />
<script src="{{ url_for('static', filename='node_modules/leaflet/dist/leaflet.js')}}"></script>
<script src="{{ url_for('static', filename='node_modules/esri-leaflet/dist/esri-leaflet.js')}}"></script>
<script src="{{ url_for('static', filename='node_modules/esri-leaflet-vector/dist/esri-leaflet-vector.js')}}"></script>
<script src="{{ url_for('static', filename='node_modules/exif-js/exif.js')}}" defer></script>
<script src="{{url_for('static', filename='node_modules/leaflet.markercluster/dist/leaflet.markercluster.js')}}"></script>
<script src="{{url_for('static', filename='node_modules/leaflet.locatecontrol/dist/L.Control.Locate.min.js')}}"></script>
<script src="{{url_for('static', filename='node_modules/heic2any/dist/heic2any.min.js')}}"></script>
<meta name="csrf-token" content="{{ csrf_token() }}">
{% endblock %}
{% block page_title %}Melden Sie Ihre Beobachtung | Mantis Religiosa Mitmachprojekt | Gottesanbeterin Gesucht{% endblock
%}
{% block title %}Fund melden{% endblock %}
{% block meta_description %} Melden Sie Ihre Beobachtungen von Mantis religiosa in Deutschland. Unterstützen Sie die
Forschung. {% endblock %}
{% block content %}
<script src="{{ url_for('static', filename='node_modules/flowbite/dist/flowbite.min.js')}}" defer></script>


<div class="flex items-center justify-center min-h-screen bg-gray-100">
  <div class="w-full p-4 mx-auto max-w-7xl">
    <form action="" method="POST" enctype="multipart/form-data" id="mainForm" data-current-step="0"
      class="p-8 transition-all duration-500 bg-white shadow-xl rounded-2xl">
      {{ form.hidden_tag() }}
      <!-- Step 1: Bild-Upload -->
      <div id="step1" class="step" data-step-index="0">
        <div class="mb-4">
          <div class="flex justify-between">
            {{ form.picture.label.text }}
            {{ popover("popover-picture", popover_content["popover-picture"]["title"], popover_content["popover-picture"]["content"], popover_content) }}
          </div>
          <!-- !TODO: Loader für Bild-Upload -->
          <div class="flex items-center justify-center w-full">
            <label for="{{ form.picture.id }}"
              class="flex flex-col items-center justify-center w-full h-64 transition-all duration-300 ease-in-out border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100"
              id="dropArea">
              <div id="imagePreview"
                class="flex-col items-center justify-center hidden w-full h-64 overflow-hidden transition-all duration-300 ease-in-out fade-in">
                <img id="previewImage" class="object-scale-down w-full h-full" src="#"
                  alt="Preview image of the mantis">
              </div>
              <div id="uploadText"
                class="flex flex-col items-center justify-center w-full h-full pt-5 pb-6 transition-all duration-300 ease-in-out">
                <svg aria-hidden="true" class="w-10 h-10 mb-3 text-gray-400" fill="none" stroke="currentColor"
                  viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                </svg>
                <p class="mb-2 text-sm text-gray-500"><span class="font-semibold">Click to upload</span> or drag and
                  drop</p>
                <p class="text-xs text-gray-500">PNG, JPG, JPEG, HEIC, HEIF or WEBP (max. 12 MB)</p>
              </div>
              <div id="uploadLoader" class="flex flex-col items-center justify-center hidden w-full h-full">
                <svg class="w-10 h-10 text-green-500 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none"
                  viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor"
                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                  </path>
                </svg>
                <p class="mt-2 text-sm text-gray-500">Bild wird hochgeladen...</p>
              </div>
              {{ form.picture(class="hidden", id=form.picture.id, accept="image/*") }}
            </label>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-4 mb-4">
          <div>
            <label for="{{ form.longitude.id }}" class="block mt-1 text-sm font-semibold text-gray-600">
              <div class="flex justify-between">
                {{ form.longitude.label.text }}
                {{ popover("popover-longitude", popover_content["popover-longitude"]["title"], popover_content["popover-longitude"]["content"], popover_content) }}
              </div>
              <div class="relative">
                {{ form.longitude(class="input-field") }}
              </div>
            </label>
          </div>
          <div>
            <label for="{{ form.latitude.id }}" class="block mt-1 text-sm font-semibold text-gray-600">
              <div class="flex justify-between">
                {{ form.latitude.label.text }}
                {{ popover("popover-latitude", popover_content["popover-latitude"]["title"], popover_content["popover-latitude"]["content"], popover_content) }}
              </div>
              <div class="relative">
                {{ form.latitude(class="input-field") }}
              </div>
            </label>
          </div>
        </div>
        <div class="col-span-full">
          <label for="map" class="block mt-1 text-sm font-semibold text-gray-600">
            <div class="flex justify-between">
              {{ "Karte: Setzen Sie den Marker in der Karte, die Koordinaten werden automatisch übernommen. Umschaltung zw. Satellitenbild und Kartenansicht via Symbol am rechten Rand." }}
              {{ popover("popover-map", popover_content["popover-map"]["title"], popover_content["popover-map"]["content"], popover_content) }}
            </div>
          </label>
          <div id="map" class="h-64 border shadow-md sm:h-96 lg:h-96"></div>
        </div>

        <div class="flex justify-end mt-4 space-x-2">
          {{ formButton('step1Next', 'Weiter') }}
        </div>
      </div>

      <!-- Step 2: Beschreibung Ort und Fund -->
      <div id="step2" class="hidden step" data-step-index="1">
        <h2 class="mb-2 text-2xl font-bold text-gray-800">Fundortbeschreibung zu den Koordinaten</h2>
        <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
          <div>
            <label for="{{ form.fund_street.id }}" class="block mt-1 text-sm font-semibold text-gray-600">
              <div class="flex justify-between">
                {{ form.fund_street.label.text }}
                {{ popover("popover-street", popover_content["popover-street"]["title"], popover_content["popover-street"]["content"], popover_content) }}
              </div>
              <div class="relative">
                {{ form.fund_street(class="input-field") }}
              </div>
            </label>
            <label for="{{ form.fund_state.id }}" class="block mt-1 text-sm font-semibold text-gray-600">
              <div class="flex justify-between">
                {{ form.fund_state.label.text }}
                {{ popover("popover-bundesland", popover_content["popover-bundesland"]["title"], popover_content["popover-bundesland"]["content"], popover_content) }}
              </div>
              <div class="relative">
                {{ form.fund_state(id="fund_state", class="input-field") }}
              </div>
            </label>
            <label for="{{ form.fund_district.id }}" class="block mt-1 text-sm font-semibold text-gray-600">
              <div class="flex justify-between">
                {{ form.fund_district.label.text }}
                {{ popover("popover-bezirk", popover_content["popover-bezirk"]["title"], popover_content["popover-bezirk"]["content"], popover_content) }}
              </div>
              <div class="relative">
                {{ form.fund_district(id="fund_district", class="input-field") }}
              </div>
            </label>

            <label class="block mt-1 text-sm font-semibold text-gray-600">
              <div class="flex justify-between">
                {{ form.gender.label.text }}
                <a href="/bestimmung" target="_blank"
                  class="inline-flex items-center justify-center px-2 py-1 text-xs font-bold text-blue-600 sm:text-xs hover:text-blue-800 hover:underline "
                  title="Anleitung zur Bestimmung in neuem Tab öffnen">
                  Anleitung zur Bestimmung
                </a>
                {{ popover("popover-gender", popover_content["popover-gender"]["title"], popover_content["popover-gender"]["content"] | safe, popover_content) }}
              </div>
              <div class="relative">
                {{ form.gender(class="block w-full px-4 py-2 text-base text-gray-700 transition-colors bg-white rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent hover:bg-gray-200") }}
              </div>
            </label>
          </div>
          <div>
            <label class="block mt-1 text-sm font-semibold text-gray-600">
              <div class="flex justify-between">
                {{ form.fund_zip_code.label.text }}
                {{ popover("popover-zip", popover_content["popover-zip"]["title"], popover_content["popover-zip"]["content"], popover_content) }}
              </div>

            </label>
            <div class="relative font-semibold">
              {{ form.fund_zip_code(id="fund_zip_code", class="input-field") }}
            </div>
            <label for="{{ form.fund_city.id }}" class="block mt-1 text-sm font-semibold text-gray-600">
              <div class="flex justify-between">
                {{ form.fund_city.label.text }}
                {{ popover("popover-city", popover_content["popover-city"]["title"], popover_content["popover-city"]["content"], popover_content) }}
              </div>
              <div class="relative">
                {{ form.fund_city(id="fund_city", class="input-field") }}
              </div>
            </label>
            <label for="{{ form.location_description.id }}" class="block mt-1 text-sm font-semibold text-gray-600">
              <div class="flex justify-between">
                {{ form.location_description.label.text }}
                {{ popover("popover-fundort", popover_content["popover-fundort"]["title"], popover_content["popover-fundort"]["content"], popover_content) }}
              </div>
              <div class="relative">
                {{ form.location_description(id=form.location_description.id, class="input-field") }}
              </div>
            </label>

            <label for="{{ form.picture_description.id }}" class="block mt-1 text-sm font-semibold text-gray-600">
              <div class="flex justify-between">
                {{ form.picture_description.label.text }}
                {{ popover("popover-beschreibung", popover_content["popover-beschreibung"]["title"], popover_content["popover-beschreibung"]["content"], popover_content) }}
              </div>
              <div class="relative">
                {{ form.picture_description(
                class="input-field") }}
              </div>
            </label>
          </div>
        </div>
        <div class="flex justify-between mt-4 space-x-2">
          {{ formButton('step2Prev', 'Zurück') }}
          {{ formButton('step2Next', 'Weiter') }}
        </div>
      </div>
      <!-- Step 3: Person(en) -->
      <div id="step3" class="hidden step" data-step-index="2">
        <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
          <div>
            <label for="{{ form.report_first_name.id }}" class="block mt-1 text-sm font-semibold text-gray-600">
              <div class="flex justify-between">
                {{ form.report_first_name.label.text }}
                {{ popover("popover-reportvorname", popover_content["popover-reportvorname"]["title"], popover_content["popover-reportvorname"]["content"], popover_content) }}
              </div>
              <div class="relative">
                {{ form.report_first_name(class="input-field") }}
              </div>
            </label>
            <label for="{{ form.report_last_name.id }}" class="block mt-1 text-sm font-semibold text-gray-600">
              <div class="flex justify-between">
                {{ form.report_last_name.label.text }}
                {{ popover("popover-reportnachname", popover_content["popover-reportnachname"]["title"], popover_content["popover-reportnachname"]["content"], popover_content) }}
              </div>
              <div class="relative">
                {{ form.report_last_name(class="input-field") }}
              </div>
            </label>
            <label for="{{ form.sighting_date.id }}" class="block mt-1 text-sm font-semibold text-gray-600">
              <div class="flex justify-between">
                {{ form.sighting_date.label.text }}
                {{ popover("popover-datum", popover_content["popover-datum"]["title"], popover_content["popover-datum"]["content"], popover_content) }}
              </div>
              <div class="relative">
                {{ form.sighting_date(class="input-field") }}
              </div>
            </label>
          </div>
          <div>
            <label for="{{ form.contact.id }}" class="block mt-1 text-sm font-semibold text-gray-600">
              <div class="flex justify-between">
                {{ form.contact.label.text }}
                {{ popover("popover-kontakt", popover_content["popover-kontakt"]["title"], popover_content["popover-kontakt"]["content"], popover_content) }}
              </div>
              <div class="relative">
                {{ form.contact(type="email", class="input-field") }}
              </div>
            </label>
            <div>
              <div id="additionalFields" class="hidden">
                <label for="{{ form.finder_first_name.id }}" class="block mt-1 text-sm font-semibold text-gray-600">
                  <div class="flex justify-between">
                    {{ form.finder_first_name.label.text }}
                  </div>
                  <div class="relative">
                    {{ form.finder_first_name(class="input-field") }}
                  </div>
                </label>
                <label for="{{ form.finder_last_name.id }}" class="block mt-1 text-sm font-semibold text-gray-600">
                  <div class="flex justify-between">
                    {{ form.finder_last_name.label.text }}
                  </div>
                  <div class="relative">
                    {{ form.finder_last_name(class="input-field") }}
                  </div>
                </label>
                <div style="display:none;">
                  <label for="honeypot">Leave this field blank</label>
                  <input type="text" id="honeypot" name="honeypot">
                </div>
              </div>
              <div class="mt-4">
                <label class="block text-sm font-semibold text-gray-600">
                  <div class="flex items-center justify-between">
                    <span>Finder und Melder sind identisch</span>
                    {{ form.identical_finder_melder(class="w-5 h-5 text-blue-600 form-checkbox") }}
                  </div>
                </label>
              </div>
            </div>
          </div>
        </div>
        <div class="flex justify-between mt-4 space-x-2">
          {{ formButton('step3Prev', 'Zurück') }}
          {{ formButton('step3Next', 'Weiter') }}
        </div>
      </div>


      <!-- Step 4: Zusammenfassung -->
      <div id="step4" class="hidden">
        <h2 class="mb-4 text-3xl font-semibold text-gray-800">Zusammenfassung</h2>
        <p>Wenn alle Angaben korrekt sind, nicht vergessen auf »Senden« zu klicken!</p>
        <div class="grid grid-cols-1 gap-6 md:grid-cols-2">
          <div class="p-5 bg-white rounded-lg shadow-md">
            <h3 class="mb-2 text-xl font-semibold text-gray-800">Bild</h3>
            <div>
              <img id="summaryImage" class="object-cover w-full h-auto rounded-lg" src="#" alt="Bildvorschau">
            </div>
          </div>
          <div class="p-5 bg-white rounded-lg shadow-md">
            <h3 class="mb-2 text-xl font-semibold text-gray-800">Standort</h3>
            <div id="summaryMap" class="h-64 rounded-lg"></div>
            <ul class="mt-3 text-lg list-disc list-inside">
              <li><strong class="text-gray-800">Längengrad:</strong> <span id="summaryLongitude"></span></li>
              <li><strong class="text-gray-800">Breitengrad:</strong> <span id="summaryLatitude"></span></li>
              <li><strong class="text-gray-800">Straße:</strong> <span id="summaryStreet"></span></li>
              <li><strong class="text-gray-800">Postleitzahl:</strong> <span id="summaryZipCode"></span></li>
              <li><strong class="text-gray-800">Ort:</strong> <span id="summaryCity"></span></li>
              <li><strong class="text-gray-800">Landkreis/Stadt:</strong> <span id="summaryDistrict"></span></li>
              <li><strong class="text-gray-800">Bundesland:</strong> <span id="summaryState"></span></li>
            </ul>
          </div>
        </div>
        <h3 class="mt-8 text-lg font-semibold text-gray-800">Beschreibung</h3>
        <ul class="text-lg list-disc list-inside">
          <li><strong class="text-gray-800">Entwicklungsstadium/Geschlecht:</strong> <span id="summaryGender"></span>
          </li>
          <li><strong class="text-gray-800">Ortsbeschreibung:</strong> <span id="summaryLocationDescription"></span>
          </li>
          <li><strong class="text-gray-800">Bildbeschreibung:</strong> <span id="summaryPictureDescription"></span></li>
        </ul>
        <h3 class="mt-8 text-lg font-semibold text-gray-800">Person</h3>
        <ul class="text-lg list-disc list-inside">
          <li><strong class="text-gray-800">Vorname:</strong> <span id="summaryFirstName"></span></li>
          <li><strong class="text-gray-800">Nachname:</strong> <span id="summaryLastName"></span></li>
          <li><strong class="text-gray-800">Funddatum:</strong> <span id="summarySightingDate"></span></li>
          <li><strong class="text-gray-800">E-Mail:</strong> <span id="summaryContact"></span></li>
        </ul>
        <div class="flex justify-between mt-6 space-x-4">
          {{ formButton('step4Prev', 'Zurück') }}
          <button id="submitBtn" type="submit"
            class="relative px-6 py-2 text-sm font-medium text-gray-100 transition duration-300 bg-green-400 rounded-md hover:bg-green-500 ease">
            <span class="absolute bottom-0 left-0 h-full -ml-2">
              <svg viewBox="0 0 487 487" class="w-auto h-full opacity-100 object-stretch"
                xmlns="http://www.w3.org/2000/svg">
                <path
                  d="M0 .3c67 2.1 134.1 4.3 186.3 37 52.2 32.7 89.6 95.8 112.8 150.6 23.2 54.8 32.3 101.4 61.2 149.9 28.9 48.4 77.7 98.8 126.4 149.2H0V.3z"
                  fill="#FFF" fill-rule="nonzero" fill-opacity=".1"></path>
              </svg>
            </span>
            <span class="absolute top-0 right-0 w-8 h-full -mr-2">
              <svg viewBox="0 0 487 487" class="object-cover w-full h-full" xmlns="http://www.w3.org/2000/svg">
                <path
                  d="M487 486.7c-66.1-3.6-132.3-7.3-186.3-37s-95.9-85.3-126.2-137.2c-30.4-51.8-49.3-99.9-76.5-151.4C70.9 109.6 35.6 54.8.3 0H487v486.7z"
                  fill="#FFF" fill-rule="nonzero" fill-opacity=".1"></path>
              </svg>
            </span>
            <span id="send" class="relative">Senden</span>
            <svg id="loadSend" class="hidden w-5 h-5 mx-auto text-gray-100 animate-spin"
              xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor"
                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
              </path>
            </svg>
          </button>
        </div>
      </div>
  </div>
</div>


<script>
  let map;
  let userMarker;
  let customIcon;  // Declare customIcon in global scope
  mapApiKey = "{{apikey}}";
  
  function initMap() {
    // Define the boundary box for Germany
    const germanyBounds = [
      [47.270111, 5.866342], // Southwest corner
      [55.058347, 15.041896]  // Northeast corner
    ];
  
    map = L.map('map', {
      maxBounds: germanyBounds,
      maxBoundsViscosity: 1.0
    }).setView([52.5200, 13.4050], 7);
  
    // Define map layers
    const openStreetMapLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      maxZoom: 18,
    });
  
    const arcGISLayer = L.esri.Vector.vectorBasemapLayer("ArcGIS:Imagery", {
      apikey: mapApiKey
    });

    // Initialize customIcon in global scope
    customIcon = L.icon({
      iconUrl: "{{ url_for('static', filename='images/map/marker-icon.png') }}",
      iconSize: [25, 41],     // Size of the icon
      iconAnchor: [12, 41],   // Point of the icon which will correspond to marker's location
      popupAnchor: [1, -34]   // Point from which the popup should open relative to the iconAnchor
    });
  
    // Add default layer to the map
    map.addLayer(openStreetMapLayer);
  
    // Layer switcher control
    var baseMaps = {
      "Karte": openStreetMapLayer,
      "Satellit": arcGISLayer
    };
  
    L.control.layers(baseMaps).addTo(map);
    L.control.locate(baseMaps).addTo(map);
  
    // Restrict zooming out too much
    const MIN_ZOOM_LEVEL = 5;
    map.on('zoomend', function () {
      if (map.getZoom() < MIN_ZOOM_LEVEL) {
        map.setZoom(MIN_ZOOM_LEVEL);
      }
    });
  
    // Load existing form data on page load
    loadFormDataFromLocalStorage();
    loadPreviewFromInput();
  
    // Check if latitude and longitude are present in the form data
    const latValue = parseFloat(document.querySelector('#latitude').value);
    const lngValue = parseFloat(document.querySelector('#longitude').value);
  
    if (!isNaN(latValue) && !isNaN(lngValue)) {
      updateMapAndFormData(latValue, lngValue, true); // Zoom to marker
    }
  
    // Update form fields on map click or manual input
    function updateMapAndFormData(lat, lng, zoomToMarker = false) {
      document.querySelector('#latitude').value = lat.toString();
      document.querySelector('#longitude').value = lng.toString();
  
      getAddressFromCoordinates(lat, lng);
  
      updateMarkerPosition(lat, lng, zoomToMarker);
  
      // Save form data to local storage with expiry
      saveFormDataToLocalStorage();
      updateSummary();
    }
  
    map.on('click', function (e) {
      updateMapAndFormData(e.latlng.lat, e.latlng.lng, false);
    });
  
    // Listen for manual coordinate input
    document.querySelector('#latitude').addEventListener('change', function () {
      const lat = parseFloat(this.value);
      const lng = parseFloat(document.querySelector('#longitude').value);
      if (!isNaN(lat) && !isNaN(lng)) {
        updateMapAndFormData(lat, lng, false);
      }
    });
  
    document.querySelector('#longitude').addEventListener('change', function () {
      const lng = parseFloat(this.value);
      const lat = parseFloat(document.querySelector('#latitude').value);
      if (!isNaN(lat) && !isNaN(lng)) {
        updateMapAndFormData(lat, lng, false);
      }
    });
  }
  
  document.addEventListener('DOMContentLoaded', initMap);
  
  function updateMarkerPosition(lat, lng, zoomToMarker) {
    if (userMarker) {
      userMarker.setLatLng([lat, lng]);
    } else {
      userMarker = L.marker([lat, lng], { icon: customIcon }).addTo(map);
    }
  
    if (zoomToMarker) {
      map.setView([lat, lng], 14); // Adjust zoom level as needed
    }
  }
  
  function getAddressFromCoordinates(latitude, longitude) {
    // Construct the API URL with precise parameters
    const nominatimUrl = `https://nominatim.openstreetmap.org/reverse` +
      `?format=jsonv2` +             // Use jsonv2 for more consistent output
      `&lat=${latitude}` +           // Latitude coordinate
      `&lon=${longitude}` +          // Longitude coordinate
      `&zoom=18` +                   // Zoom level for building detail
      `&addressdetails=1` +          // Include detailed address components
      `&extratags=1` +               // Include extra tags like ISO3166-2 codes
      `&namedetails=1` +             // Include name details
      `&accept-language=de`;         // Get results in German
  
    // Fetch data from the Nominatim API
    fetch(nominatimUrl)
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        // Check for errors in the API response
        if (data.error) {
          console.error("Error from Nominatim API:", data.error);
          return;
        }
  
        console.log(data); // Log the full response for debugging
        const address = data.address || {};
  
        // Extract and set the zip code
        const zipCode = address.postcode || "";
        document.querySelector("#fund_zip_code").value = zipCode;
  
        // Extract and set the city
        const city = address.city || address.town || address.village ||
                     address.hamlet || address.suburb || address.locality || "";
        document.querySelector("#fund_city").value = city;
  
        // Extract and set the street address
        const streetName = address.road || address.pedestrian || address.cycleway ||
                           address.path || address.footway || address.street ||
                           address.street_name || "";
        const houseNumber = address.house_number || "";
        const street = `${streetName} ${houseNumber}`.trim();
        document.querySelector("#fund_street").value = street;
  
        // Extract and set the state (Bundesland)
        let state = address.state || address.region || "";
        if (!state && data.extratags && data.extratags["ISO3166-2"]) {
          const isoCode = data.extratags["ISO3166-2"];
          state = getStateNameFromISOCode(isoCode);
        }
        if (!state && address.city && isCityState(address.city)) {
          state = address.city;
        }
        document.querySelector("#fund_state").value = state;
  
        // Extract and set the district (Landkreis/Stadtteil)
        const district = address.county || address.district || address.municipality ||
                         address.city_district || address.borough || address.suburb || "";
        document.querySelector("#fund_district").value = district;
  
        // Prepare address data for validation and save to local storage
        const addressData = {
          state: state,
          district: district,
          city: city,
          street: street,
          zipCode: zipCode
        };
  
        // Save address data to local storage
        setLocalStorageWithExpiry('addressData', JSON.stringify(addressData), 3600000); // 1 hour expiry
  
        // Function to check user-provided address data against API data
        function checkAddressData(formData, nextStepIndex) {
          // const storedAddressData = JSON.parse(getLocalStorageWithExpiry('addressData')) || {};
          // const userState = formData.get('fund_state') || "";
          // const userDistrict = formData.get('fund_district') || "";
          // const userCity = formData.get('fund_city') || "";
  
          // const errors = {};
  
          // // Case-insensitive and trimmed comparison
          // if (storedAddressData.state && userState.trim().toLowerCase() !== storedAddressData.state.trim().toLowerCase()) {
          //   errors.fund_state = ['Das eingegebene Bundesland stimmt nicht mit den Fundort-Koordinaten überein.'];
          // }
          // if (storedAddressData.district && userDistrict.trim().toLowerCase() !== storedAddressData.district.trim().toLowerCase()) {
          //   errors.fund_district = ['Der eingegebene Landkreis/Stadtteil stimmt nicht mit den Fundort-Koordinaten überein.'];
          // }
          // if (storedAddressData.city && userCity.trim().toLowerCase() !== storedAddressData.city.trim().toLowerCase()) {
          //   errors.fund_city = ['Der eingegebene Ort stimmt nicht mit den Fundort-Koordinaten überein.'];
          // }
  
          // if (Object.keys(errors).length > 0) {
          //   showErrors(errors, 1); // Function to display errors
          // } else {
            showStep(nextStepIndex); // Function to proceed to the next step
          // }
        }
  
        // Make the checkAddressData function globally accessible
        window.checkAddressData = checkAddressData;
      })
      .catch(error => {
        console.error("Error fetching address data:", error);
      });
  }
  
  // Helper function to map ISO3166-2 codes to state names
  function getStateNameFromISOCode(isoCode) {
    const isoToStateMap = {
      'DE-BW': 'Baden-Württemberg',
      'DE-BY': 'Bayern',
      'DE-BE': 'Berlin',
      'DE-BB': 'Brandenburg',
      'DE-HB': 'Bremen',
      'DE-HH': 'Hamburg',
      'DE-HE': 'Hessen',
      'DE-MV': 'Mecklenburg-Vorpommern',
      'DE-NI': 'Niedersachsen',
      'DE-NW': 'Nordrhein-Westfalen',
      'DE-RP': 'Rheinland-Pfalz',
      'DE-SL': 'Saarland',
      'DE-SN': 'Sachsen',
      'DE-ST': 'Sachsen-Anhalt',
      'DE-SH': 'Schleswig-Holstein',
      'DE-TH': 'Thüringen'
    };
    return isoToStateMap[isoCode] || '';
  }
  
  // Helper function to check if a city is a city-state
  function isCityState(cityName) {
    const cityStates = ['Berlin', 'Hamburg', 'Bremen'];
    return cityStates.includes(cityName);
  }
  
  // Use Jinja2 to pass the Python variables to JavaScript
  const existingUser = {{ existing_user | tojson | safe }};

// Check if the existingUser is not null
if (existingUser) {
  const fields = [
    { id: "report_first_name", value: existingUser.user_name.split(" ")[1] },
    { id: "report_last_name", value: existingUser.user_name.split(" ")[0] },
    { id: "contact", value: existingUser.user_kontakt }
  ];

  fields.forEach(field => {
    const element = document.getElementById(field.id);
    element.value = field.value;
    element.readOnly = true;
  });
}

function setLocalStorageWithExpiry(key, value, ttl) {
  const now = new Date();
  const item = {
    value: value,
    expiry: now.getTime() + ttl,
  };
  try {
    localStorage.setItem(key, JSON.stringify(item));
  } catch (e) {
    console.error("Error setting localStorage item:", e);
  }
}

function getLocalStorageWithExpiry(key) {
  try {
    const itemStr = localStorage.getItem(key);
    if (!itemStr) {
      return null;
    }
    const item = JSON.parse(itemStr);
    const now = new Date();
    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key);
      return null;
    }
    return item.value;
  } catch (e) {
    console.error("Error getting localStorage item:", e);
    return null;
  }
}

function cleanupExpiredItems() {
  const keys = Object.keys(localStorage);
  for (const key of keys) {
    getLocalStorageWithExpiry(key); // This will remove the item if it's expired
  }
}

// Call this function periodically or on page load
cleanupExpiredItems();

function saveFormDataToLocalStorage() {
  const form = document.getElementById('mainForm');
  const formData = new FormData(form);
  const data = {};

  for (const [key, value] of formData.entries()) {
    if (key !== "csrf_token" && key !== "picture") {
      data[key] = value;
    }
  }

  // Set expiry to 1 hour (3600000 milliseconds)
  setLocalStorageWithExpiry('formData', JSON.stringify(data), 3600000);
}

function loadFormDataFromLocalStorage() {
  const form = document.getElementById('mainForm');
  const storedData = getLocalStorageWithExpiry('formData');

  if (storedData) {
    try {
      const data = JSON.parse(storedData);
      for (const input of form.elements) {
        if (input.name && input.type !== 'file' && data.hasOwnProperty(input.name)) {
          input.value = data[input.name];
        }
      }
    } catch (e) {
      console.error('Error parsing stored form data:', e);
    }
  }
}

function loadPreviewFromInput() {
  const pictureInput = document.getElementById('picture');
  const preview = document.getElementById('previewImage');
  const previewContainer = document.getElementById('imagePreview');
  const uploadText = document.getElementById('uploadText');

  if (!pictureInput || !preview || !previewContainer || !uploadText) {
    return;
  }

  const file = pictureInput.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function (e) {
      preview.src = e.target.result;
      previewContainer.style.display = 'flex';
      uploadText.style.display = 'none';
    };
    reader.onerror = function (e) {
      resetPreview();
    };
    reader.readAsDataURL(file);
  } else {
    resetPreview();
  }
}

// Save form data on input change
document.getElementById('mainForm').addEventListener('input', saveFormDataToLocalStorage);

// EXIF Data Extraction
document.addEventListener('DOMContentLoaded', function () {
  const pictureInput = document.querySelector('#picture');
  pictureInput.addEventListener('change', function (event) {
    const file = event.target.files[0];
    if (!file) return;

    // Use FileReader to read the file as an ArrayBuffer
    const reader = new FileReader();
    reader.onload = function (e) {
      try {
        const exifData = EXIF.readFromBinaryFile(e.target.result);

        if (exifData) {
          const lat = exifData.GPSLatitude;
          const lng = exifData.GPSLongitude;
          const latRef = exifData.GPSLatitudeRef;
          const lngRef = exifData.GPSLongitudeRef;

          if (lat && lng && latRef && lngRef) {
            // Convert coordinates to decimal without rounding
            const latitude = toDecimal(lat, latRef);
            const longitude = toDecimal(lng, lngRef);

            // if values are NaN or 0, do not set the form fields
            if (isNaN(latitude) || isNaN(longitude) || latitude === 0 || longitude === 0) {
              return;
            }

            // Update map and form data
            updateMapAndFormData(latitude, longitude, true);
          }

          // Extract and set the sighting date
          if (exifData.DateTimeOriginal) {
            const dateTime = exifData.DateTimeOriginal.split(' ')[0].replace(/:/g, '-');
            document.querySelector('#sighting_date').value = dateTime;
          }
        }
      } catch (error) {
        console.error('Error processing EXIF data:', error);
      }
    };

    reader.readAsArrayBuffer(file);
  });
});

function toDecimal(coord, ref) {
  if (!Array.isArray(coord) || coord.length !== 3) {
    return NaN;
  }

  const [degrees, minutes, seconds] = coord.map(val =>
    typeof val === 'number' ? val : (val.numerator / val.denominator)
  );

  let decimal = degrees + minutes / 60 + seconds / (60 * 60);
  if (ref === 'S' || ref === 'W') {
    decimal = -decimal;
  }
  return decimal;
}

// Image Upload and Preview Handling
const input = document.getElementById('{{ form.picture.id }}');
const preview = document.getElementById('previewImage');
const previewContainer = document.getElementById('imagePreview');
const uploadText = document.getElementById('uploadText');
const uploadLoader = document.getElementById('uploadLoader');

input.addEventListener('change', handleImageUpload);
document.addEventListener('drop', dropHandler);

function handleImageUpload(e) {
  const file = e.target.files[0];
  const validFileTypes = ["image/png", "image/jpeg", "image/jfif", "image/webp", "image/heic", "image/heif"];
  const maxSizeInBytes = 12 * 1024 * 1024; // 12MB

  clearErrorsForField('picture');
  resetPreview(); // Reset preview before processing new image

  if (file) {
    if (!validFileTypes.includes(file.type.toLowerCase())) {
      showErrors({ picture: ["Erlaubt sind nur PNG, JPG, JPEG, HEIC, HEIF und WebP Dateien."] }, 0);
      e.target.value = '';
      return;
    }

    if (file.size > maxSizeInBytes) {
      showErrors({ picture: ["Die Datei ist zu groß. Maximale Größe ist 12MB."] }, 0);
      e.target.value = '';
      return;
    }

    // Show loader
    uploadText.style.display = 'none';
    uploadLoader.classList.remove('hidden');

    // Process the file based on its type
    if (file.type.startsWith('image/heic') || file.type.startsWith('image/heif')) {
      processHeicHeif(file);
    } else if (file.type === 'image/webp') {
      // WebP files don't need conversion
      validateAndUpdatePreview(file);
    } else {
      // For other image types, validate and convert if necessary
      validateAndConvertIfNeeded(file);
    }
  }
}

function processHeicHeif(file) {
  heic2any({
    blob: file,
    toType: "image/jpeg",
  }).then(function (resultBlob) {
    validateAndConvertIfNeeded(new File([resultBlob], file.name, { type: 'image/jpeg' }));
  }).catch(function (error) {
    handleHeicHeifError(error);
  });
}

function handleHeicHeifError(error) {
  let errorMessage = "Die HEIC/HEIF-Datei konnte nicht verarbeitet werden.";
  showErrors({ picture: [errorMessage] }, 0);
  resetPreview();
}

function validateAndConvertIfNeeded(file) {
  const img = new Image();
  img.onload = function() {
    URL.revokeObjectURL(this.src);
    if (file.size > 10 * 1024 * 1024 || file.type !== 'image/webp') {
      // Convert to WebP if file is large or not already WebP
      convertToWebP(file, file.size > 10 * 1024 * 1024 ? 0.5 : 0.7);
    } else {
      // File is already WebP and not too large, just update preview
      updatePreview(file);
    }
  };
  img.onerror = function() {
    URL.revokeObjectURL(this.src);
    showErrors({ picture: ["Das Bild konnte nicht geladen werden. Bitte versuchen Sie es mit einem anderen Bild."] }, 0);
    resetPreview();
  };
  img.src = URL.createObjectURL(file);
}

function validateAndUpdatePreview(file) {
  const img = new Image();
  img.onload = function() {
    URL.revokeObjectURL(this.src);
    updatePreview(file);
  };
  img.onerror = function() {
    URL.revokeObjectURL(this.src);
    showErrors({ picture: ["Die Datei scheint kein gültiges Bild zu sein."] }, 0);
    resetPreview();
  };
  img.src = URL.createObjectURL(file);
}

function convertToWebP(file, quality) {
  var img = new Image();
  img.onload = function () {
    var canvas = document.createElement('canvas');
    canvas.width = img.width;
    canvas.height = img.height;
    var ctx = canvas.getContext('2d');
    ctx.drawImage(img, 0, 0, img.width, img.height);
    canvas.toBlob(function (blob) {
      var convertedFile = new File([blob], 'image.webp', { type: 'image/webp' });

      if (convertedFile.size > 12 * 1024 * 1024) {
        showErrors({ picture: ["Das Bild ist zu groß. Bitte verwenden Sie ein kleineres Bild oder reduzieren Sie die Bildqualität."] }, 0);
        resetPreview();
        return;
      }

      var dataTransfer = new DataTransfer();
      dataTransfer.items.add(convertedFile);
      input.files = dataTransfer.files;
      updatePreview(convertedFile);
    }, 'image/webp', quality);
  };
  img.onerror = function() {
    showErrors({ picture: ["Das Bild konnte nicht konvertiert werden. Bitte versuchen Sie es mit einem anderen Bild."] }, 0);
    resetPreview();
  };
  img.src = URL.createObjectURL(file);
}

function dropHandler(ev) {
  ev.preventDefault();
  if (ev.dataTransfer.items) {
    for (var i = 0; i < ev.dataTransfer.items.length; i++) {
      if (ev.dataTransfer.items[i].kind === 'file') {
        var file = ev.dataTransfer.items[i].getAsFile();
        convertImageToWebP(file);
      }
    }
  }
}

function convertImageToWebP(file) {
  if (file.type.startsWith('image/heic') || file.type.startsWith('image/heif')) {
    heic2any({
      blob: file,
      toType: "image/jpeg",
    }).then(function (resultBlob) {
      // Check the size of the converted JPG
      if (resultBlob.size > 10 * 1024 * 1024) {
        // If larger than 10MB, use stronger compression
        convertToWebP(resultBlob, 0.5);  // Adjust compression level as needed
      } else {
        convertToWebP(resultBlob, 0.7);  // Use normal compression
      }
    }).catch(function (x) {
      console.error(x.message);
      // Hide loader and show upload text on error
      uploadLoader.classList.add('hidden');
      uploadText.style.display = 'flex';
    });
  } else {
    convertToWebP(file, 0.7);  // Use normal compression for non-HEIC files
  }
}

function updatePreview(file) {
  var reader = new FileReader();
  reader.onload = function (e) {
    previewContainer.style.display = 'flex';
    preview.src = e.target.result;
    uploadText.style.display = 'none';
    uploadLoader.classList.add('hidden');  // Ensure loader is hidden
  };
  reader.readAsDataURL(file);
}

function resetPreview() {
  preview.src = '';
  previewContainer.style.display = 'none';
  uploadText.style.display = 'flex';
  uploadLoader.classList.add('hidden');
}


  function clearErrorsForField(fieldName) {
    // Remove error styling from picture label
    const label = document.querySelector(`label[for="${fieldName}"]`);
    if (label) {
      label.classList.remove('error-field');
    }

    // Clear any existing error messages
    const field = document.querySelector(`[name="${fieldName}"]`);
    const errorElement = field.parentElement.querySelector('.form-error');
    if (errorElement) {
      // Remove error styling from field
      field.classList.remove('error-field');
      errorElement.remove();
    }
  }

  function validateForm(event, nextStepIndex) {
    event.preventDefault();
    const form = event.target.closest('form');
    const formData = new FormData();

    // Add the current step index to the FormData
    formData.append('stepIndex', nextStepIndex);

    // Only append form elements that are relevant to the current step
    for (const element of form.elements) {
      if (element.name === 'picture' && nextStepIndex !== 1) {
        continue; // Skip appending the picture for steps other than the first
      }
      if (element.type === 'file') {
        formData.append(element.name, element.files[0]);
      } else {
        formData.append(element.name, element.value);
      }
    }

    let csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    const button = event.target.closest('a');
    const buttonId = button.id;
    const buttonLoader = document.getElementById(buttonId + 'Loader');
    const buttonText = document.getElementById(buttonId + 'Text');

    if (!buttonLoader || !buttonText) {
      console.error('Button loader or text not found');
      return;
    }

    // Check if the button is already in loading state
    if (buttonLoader.classList.contains('loading')) {
      return; // Exit if the button is already loading
    }

    // Add a 'loading' class to the buttonLoader to track the loading state
    buttonLoader.classList.add('loading');

    // Toggle the loading SVG and the button text
    buttonLoader.classList.remove('hidden');
    buttonText.classList.add('hidden');


    fetch('/validate', {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrfToken
      },
      body: formData
    })
      .then(response => {
        // Remove the 'loading' class to indicate the loading is done
        buttonLoader.classList.remove('loading');
        buttonLoader.classList.add('hidden');
        buttonText.classList.remove('hidden');


        if (!response.ok && response.status !== 333) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        const currentStepErrors = showErrors(data.errors, form.dataset.currentStep);
        if (currentStepErrors.length === 0) {
          if (nextStepIndex === 2) {
            checkAddressData(formData, nextStepIndex);
          } else {
            showStep(nextStepIndex);
          }
        }
      })
      .catch(error => {
        // Remove the 'loading' class in case of an error as well
        buttonLoader.classList.remove('loading');
        buttonLoader.classList.add('hidden');
        buttonText.classList.remove('hidden');


        console.error(error);
      });
  }


  function showErrors(errors, currentStepIndex) {
    currentStepIndex = parseInt(currentStepIndex);  // parse to integer


    // Clear any existing error messages
    const errorElements = document.querySelectorAll('.form-error');
    errorElements.forEach(el => {
      // Remove error styling from field
      el.previousElementSibling.classList.remove('error-field');
      el.remove();
    });

    // Remove error styling from picture label
    const pictureLabel = document.querySelector('label[for="picture"]');
    if (pictureLabel) {
      pictureLabel.classList.remove('error-field');
    }

    let currentStepErrors = [];  // to keep track of errors in the current step

    // Add new error messages
    for (let fieldName in errors) {
      const fieldErrors = errors[fieldName];
      const field = document.querySelector(`[name="${fieldName}"]`);
      if (field && field.closest('.step') && parseInt(field.closest('.step').dataset.stepIndex) === currentStepIndex) {
        // If the field is the picture field, add error styling to the label
        if (fieldName === 'picture') {
          const label = document.querySelector(`label[for="${fieldName}"]`);
          label.classList.add('error-field');
        } else {
          // Add error styling to field
          field.classList.add('error-field');
        }

        const errorContainer = document.createElement('div');
        errorContainer.classList.add('form-error');
        errorContainer.style.display = 'flex'; // This line added
        errorContainer.style.alignItems = 'center'; // To vertically align the items
        errorContainer.style.margin = '0 0 0.5rem 0'; // To add space between the SVG and the text
        errorContainer.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4" style="margin-right: 0.5rem;">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
          </svg>
          <span style="font-size: 0.75rem;">${fieldErrors.join(', ')}</span>
        `;

        field.parentElement.insertBefore(errorContainer, field.nextSibling);
        currentStepErrors.push(fieldName);  // add to the list of current step errors
      }
    }

    return currentStepErrors;  // return the list of current step errors
  }


  const steps = ['step1', 'step2', 'step3', 'step4'];
  const stepElements = steps.map(step => document.getElementById(step));
  const [step1, step2, step3, step4] = stepElements;

  const stepButtons = [
    { element: document.getElementById('step1Next'), action: (event) => validateForm(event, 1) },
    { element: document.getElementById('step2Prev'), action: () => showStep(0) },
    { element: document.getElementById('step2Next'), action: (event) => validateForm(event, 2) },
    { element: document.getElementById('step3Prev'), action: () => showStep(1) },
    { element: document.getElementById('step3Next'), action: (event) => validateForm(event, 3) },
    { element: document.getElementById('step4Prev'), action: () => showStep(2) },
  ];

  stepButtons.forEach(({ element, action }) => {
    element.addEventListener('click', action);
  });

  const additionalFields = document.getElementById('additionalFields');
  const form = document.getElementById('mainForm');

  function showStep(index) {
    form.dataset.currentStep = index;

    stepElements.forEach((step, i) => {
      step.classList.toggle('hidden', index !== i);
    });

    if (index === 3) {
      setTimeout(() => {
        summaryMap.invalidateSize();
      }, 400);
    }

    if (index === 2) {
      additionalFields.classList.toggle('hidden', form.identical_finder_melder.checked);
    }
  }


  form.identical_finder_melder.addEventListener('change', () => {
    additionalFields.classList.toggle('hidden', form.identical_finder_melder.checked);
  });

  function autoCompleteData(inputField, zipCode, city, district, state) {
    var inputs = ['fund_zip_code', 'fund_city', 'fund_district', 'fund_state'];

    for (const id of inputs) {
      if (inputField.id === id) continue;
      let fieldValue = null;

      switch (id) {
        case 'fund_zip_code':
          fieldValue = zipCode;
          break;
        case 'fund_city':
          fieldValue = city;
          break;
        case 'fund_district':
          fieldValue = district;
          break;
        case 'fund_state':
          fieldValue = state;
          break;
      }

      document.getElementById(id).value = fieldValue || '';
    }
  }



  document.getElementById('mainForm').addEventListener('submit', (event) => {
    event.preventDefault();  // Prevent the form from submitting immediately
    var loadingMsg = document.getElementById('loadSend');
    var submitBtn = document.getElementById('submitBtn');
    var send = document.getElementById('send');

    // Disable the submit button and show loading message
    submitBtn.disabled = true;
    console.log('Button disabled');

    send.classList.add('hidden');
    console.log('Send hidden');

    loadingMsg.classList.remove('hidden');
    console.log('Loading shown');

    // Use a flag to ensure the form is submitted only once
    if (!submitBtn.classList.contains('form-submitted')) {
      submitBtn.classList.add('form-submitted');
      event.target.submit();

      // Clear localStorage after form-submitted class is added
      localStorage.clear();
    }
  });




  // Step 4: Zusammenfassung und Vorschau
  // Map initialization
  // Second Map:
  const summaryMap = L.map("summaryMap").setView([0, 0], 13);
  mapApiKey = "{{apikey}}"

  // Define map layers
  const openStreetMapLayerSummary = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors',
    maxZoom: 18,
  });

  const arcGISLayerSummary = L.esri.Vector.vectorBasemapLayer("ArcGIS:Imagery", {
    apikey: mapApiKey // Add your actual API key here
  });

  // Custom marker icon configuration
  var customIcon2 = L.icon({
    iconUrl: "{{ url_for('static', filename='images/map/marker-icon.png') }}",
    iconSize: [25, 41],     // Size of the icon
    iconAnchor: [12, 41],   // Point of the icon which will correspond to marker's location
    popupAnchor: [1, -34]   // Point from which the popup should open relative to the iconAnchor
  });

  // Add default layer to the map
  summaryMap.addLayer(openStreetMapLayerSummary);

  // Layer switcher control
  var baseMapsSummary = {
    "OpenStreetMap": openStreetMapLayerSummary,
    "ArcGIS": arcGISLayerSummary
  };

  L.control.layers(baseMapsSummary).addTo(summaryMap);

  const summaryMarker = L.marker([0, 0], { icon: customIcon2 }).addTo(summaryMap);
  const summaryMarkerPopup = L.popup().setContent("");
  summaryMarker.bindPopup(summaryMarkerPopup);

  const updateSummary = () => {
    const storedData = getLocalStorageWithExpiry('formData');

    if (storedData) {
      try {
        const data = JSON.parse(storedData);
        // Update the location on the map
        const newLatLng = new L.LatLng(data.latitude, data.longitude);
        summaryMarker.setLatLng(newLatLng);
        summaryMap.setView(newLatLng, 13);

        // Add a delay before calling invalidateSize
        setTimeout(() => {
          summaryMap.invalidateSize();
        }, 400); // Adjust delay as needed

        // Update the popup content using template literals for better readability
        const popupContent = `
          <strong>Straße:</strong> ${data.street}<br>
          <strong>Postleitzahl:</strong> ${data.fund_zip_code}<br>
          <strong>Ort:</strong> ${data.fund_city}<br>
          <strong>Landkreis/Stadt:</strong> ${data.fund_district}<br>
          <strong>Bundesland:</strong> ${data.fund_state}
        `;
        summaryMarkerPopup.setContent(popupContent);

        // Picture is loaded directly from input not from localStorage
        const pictureInput = document.getElementById('picture');
        const file = pictureInput.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function () {
            summaryImage.src = reader.result;
          };
          reader.readAsDataURL(file);
        } else {
          summaryImage.src = '#';
        }

        // Get the selected text from the location_description dropdown
        const selectLocationDescriptionElement = document.getElementById('location_description');
        const selectedLocationDescriptionText = selectLocationDescriptionElement.options[selectLocationDescriptionElement.selectedIndex].text;

        summaryLongitude.textContent = data.longitude;
        summaryLatitude.textContent = data.latitude;
        summaryStreet.textContent = data.fund_street;
        summaryZipCode.textContent = data.fund_zip_code;
        summaryCity.textContent = data.fund_city;
        summaryDistrict.textContent = data.fund_district;
        summaryState.textContent = data.fund_state;
        summaryGender.textContent = data.gender;
        summaryLocationDescription.textContent = selectedLocationDescriptionText;
        summaryPictureDescription.textContent = data.picture_description;
        summaryFirstName.textContent = data.report_first_name;
        summaryLastName.textContent = data.report_last_name;
        summarySightingDate.textContent = data.sighting_date;
        summaryContact.textContent = data.contact;
      } catch (e) {
        console.error('Error parsing stored form data in updateSummary:', e);
      }
    }
  }

  // Call the updateSummary function whenever the form inputs change
  document.querySelectorAll('input, select, textarea').forEach(function (input) {
    input.addEventListener('input', function () {
      // Store form data in local storage on input change
      let formData = {};
      document.querySelectorAll('input, select, textarea').forEach(function (input) {
        formData[input.id] = input.value;
      });
      setLocalStorageWithExpiry('formData', JSON.stringify(formData), 3600000);
      updateSummary();
    });
  });

  // Initially update the summary
  document.addEventListener('DOMContentLoaded', updateSummary);

</script>
{% endblock content %}