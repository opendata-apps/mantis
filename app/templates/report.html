{% extends "layout.html" %} {% block content %}

<body>
  <form action="" method="POST" enctype="multipart/form-data">
    {{ form.hidden_tag() }}
    {{ form.picture.label }} {{ form.picture }}
    {{ form.gender.label }} {{ form.gender }}
    {{ form.picture_description.label }} {{ form.picture_description }}

    {{ form.coordinates.label }} {{ form.coordinates }}
    {{ form.zip_code.label }} {{ form.zip_code(id="zip_code") }}
    {{ form.city.label }} {{ form.city(id="city") }}
    {{ form.street.label }} {{ form.street }}
    {{ form.country.label }} {{ form.country(id="country") }}
    {{ form.district.label }} {{ form.district(id="district") }}
    {{ form.location_description.label }} {{ form.location_description }}

    {{ form.first_name.label }} {{ form.first_name }}
    {{ form.last_name.label }} {{ form.last_name }}
    {{ form.sighting_date.label }} {{ form.sighting_date }}
    {{ form.contact.label }} {{ form.contact }}
    {{ form.feedback.label }} {{ form.feedback }}

    {{ form.submit }}
  </form>
  <script>
    function autoCompleteData(inputField, zipCode, city, district, country) {
      var inputs = ['zip_code', 'city', 'district', 'country'];

      for (const id of inputs) {
        if (inputField.id === id) continue;
        let fieldValue = null;

        switch (id) {
          case 'zip_code':
            fieldValue = zipCode;
            break;
          case 'city':
            fieldValue = city;
            break;
          case 'district':
            fieldValue = district;
            break;
          case 'country':
            fieldValue = country;
            break;
        }

        document.getElementById(id).value = fieldValue || '';
      }
    }

    function getAutoCompleteData(inputField) {
      var query = inputField.value;
      if (query) {
        fetch('/autocomplete?q=' + query)
          .then(response => response.json())
          .then(data => {
            if (data.length > 0) {
              var firstResult = data[0];
              autoCompleteData(inputField, firstResult.plz, firstResult.ort, firstResult.landkreis, firstResult.bundesland);
            }
          });
      }
    }

    document.addEventListener('DOMContentLoaded', function () {
      var zipCodeInput = document.getElementById('zip_code');

      function addEvents(inputField) {
        inputField.addEventListener('keydown', function (event) {
          if (event.key === 'Enter' || event.key === 'Tab') {
            if (inputField.value.length >= 5) {
              getAutoCompleteData(inputField);
            }
          }
        });
        inputField.addEventListener('blur', function () {
          if (inputField.value.length >= 5) {
            getAutoCompleteData(inputField);
          }
        });
        //if input field is empty, clear all other fields related to it
        inputField.addEventListener('input', function () {
          if (inputField.value === '') {
            autoCompleteData(inputField, '', '', '', '');
          }
        });
      }

      addEvents(zipCodeInput);
    });
  </script>


</body>


{% endblock content %}