{% extends "layout.html" %}
{% block head %}
<script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
{% endblock %}
{% block content %}

<body>
  <div class="flex items-center my-16 bg-gray-100">
    <div class="flex-1 max-w-4xl p-6 mx-auto bg-white rounded-lg shadow-xl">
      <form action="" method="POST" enctype="multipart/form-data" id="mainForm">
        <!-- Nutzereingabe Step Start-->
        <div id="step1" class="step">
          {{ form.hidden_tag() }}
          <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
            <div>
              {{ form.picture.label(class="block text-sm font-semibold text-gray-600") }}
              {{ form.picture(class="w-full p-2 mt-1 bg-white border rounded-md focus:outline-none focus:ring-1
              focus:ring-green-500") }}
            </div>
            <div>
              {{ form.gender.label(class="block text-sm font-semibold text-gray-600") }}
              {{ form.gender(class="w-full p-2 mt-1 bg-white border rounded-md focus:outline-none focus:ring-1
              focus:ring-green-500") }}
            </div>
          </div>
          <div>
            {{ form.picture_description.label(class="block mt-4 text-sm font-semibold text-gray-600") }}
            {{ form.picture_description(class="w-full p-2 mt-1 bg-white border rounded-md focus:outline-none
            focus:ring-1 focus:ring-green-500") }}
          </div>
          <div class="flex justify-end">
            <button type="button" id="step1Next"
              class="px-6 py-2 mt-4 text-sm font-medium leading-5 text-center text-white transition-colors duration-150 bg-green-500 border border-transparent rounded-lg hover:bg-green-600 focus:outline-none">
              Next
            </button>
          </div>
        </div>
        <!-- Nutzereingabe Step End-->

        <!-- Fundort Step Start-->
        <div id="step2" class="hidden step">
          <div class="grid grid-cols-1 gap-4 mt-4 md:grid-cols-2">
            <div>
              {{ form.longitude.label(class="block text-sm font-semibold text-gray-600") }}
              {{ form.longitude(class="w-full p-2 mt-1 bg-white border rounded-md focus:outline-none focus:ring-1
              focus:ring-green-500") }}
            </div>
            <div>
              {{ form.latitude.label(class="block text-sm font-semibold text-gray-600") }}
              {{ form.latitude(class="w-full p-2 mt-1 bg-white border rounded-md focus:outline-none focus:ring-1
              focus:ring-green-500") }}
            </div>
            <div>
              {{ form.zip_code.label(class="block text-sm font-semibold text-gray-600") }}
              {{ form.zip_code(id="zip_code", class="w-full p-2 mt-1 bg-white border rounded-md focus:outline-none
              focus:ring-1 focus:ring-green-500") }}
            </div>
            <div>
              {{ form.city.label(class="block text-sm font-semibold text-gray-600") }}
              {{ form.city(id="city", class="w-full p-2 mt-1 bg-white border rounded-md focus:outline-none focus:ring-1
              focus:ring-green-500") }}
            </div>
            <div>
              {{ form.street.label(class="block text-sm font-semibold text-gray-600") }}
              {{ form.street(class="w-full p-2 mt-1 bg-white border rounded-md focus:outline-none focus:ring-1
              focus:ring-green-500") }}
            </div>
            <div>
              {{ form.country.label(class="block text-sm font-semibold text-gray-600") }}
              {{ form.country(id="country", class="w-full p-2 mt-1 bg-white border rounded-md focus:outline-none
              focus:ring-1 focus:ring-green-500") }}
            </div>
            <div>
              {{ form.district.label(class="block text-sm font-semibold text-gray-600") }}
              {{ form.district(id="district", class="w-full p-2 mt-1 bg-white border rounded-md focus:outline-none
              focus:ring-1 focus:ring-green-500") }}
            </div>
          </div>
          <div>
            {{ form.location_description.label(class="block mt-4 text-sm font-semibold text-gray-600") }}
            {{ form.location_description(class="w-full p-2 mt-1 bg-white border rounded-md focus:outline-none
            focus:ring-1 focus:ring-green-500") }}
          </div>
          <div class="flex justify-between">
            <button type="button" id="step2Prev"
              class="px-6 py-2 mt-4 text-sm font-medium leading-5 text-center text-white transition-colors duration-150 bg-green-500 border border-transparent rounded-lg hover:bg-green-600 focus:outline-none">
              Prev
            </button>
            <button type="button" id="step2Next"
              class="px-6 py-2 mt-4 text-sm font-medium leading-5 text-center text-white transition-colors duration-150 bg-green-500 border border-transparent rounded-lg hover:bg-green-600 focus:outline-none">
              Next
            </button>
          </div>
        </div>
        <!-- Fundort Step End-->

        <!-- Melderinfo Step Start-->
        <div id="step3" class="hidden step">
          <div class="grid grid-cols-1 gap-4 mt-4 md:grid-cols-2">
            <div>
              {{ form.first_name.label(class="block text-sm font-semibold text-gray-600") }}
              {{ form.first_name(class="w-full p-2 mt-1 bg-white border rounded-md focus:outline-none focus:ring-1
              focus:ring-green-500") }}
            </div>
            <div>
              {{ form.last_name.label(class="block text-sm font-semibold text-gray-600") }}
              {{ form.last_name(class="w-full p-2 mt-1 bg-white border rounded-md focus:outline-none focus:ring-1
              focus:ring-green-500") }}
            </div>
            <div>
              {{ form.sighting_date.label(class="block text-sm font-semibold text-gray-600") }}
              {{ form.sighting_date(class="w-full p-2 mt-1 bg-white border rounded-md focus:outline-none focus:ring-1
              focus:ring-green-500") }}
            </div>
            <div>
              {{ form.contact.label(class="block text-sm font-semibold text-gray-600") }}
              {{ form.contact(class="w-full p-2 mt-1 bg-white border rounded-md focus:outline-none focus:ring-1
              focus:ring-green-500") }}
            </div>
          </div>
          <div>
            {{ form.feedback.label(class="block mt-4 text-sm font-semibold text-gray-600") }}
            {{ form.feedback(class="w-full p-2 mt-1 bg-white border rounded-md focus:outline-none focus:ring-1
            focus:ring-green-500") }}
          </div>
          <div class="flex justify-between">
            <button type="button" id="step3Prev"
              class="px-6 py-2 mt-4 text-sm font-medium leading-5 text-center text-white transition-colors duration-150 bg-green-500 border border-transparent rounded-lg hover:bg-green-600 focus:outline-none">
              Prev
            </button>
            <button type="submit"
              class="px-6 py-2 mt-4 text-sm font-medium leading-5 text-center text-white transition-colors duration-150 bg-green-500 border border-transparent rounded-lg hover:bg-green-600 focus:outline-none">
              Submit
            </button>
          </div>
        </div>
        <!-- Melderinfo Step End-->
      </form>



      <script>
        document.addEventListener('DOMContentLoaded', function () {
          const pictureInput = document.querySelector('#picture');

          pictureInput.addEventListener('change', function (event) {
            const file = event.target.files[0];
            if (!file) return;

            EXIF.getData(file, function () {
              // Read metadata from the image
              const lat = EXIF.getTag(this, 'GPSLatitude');
              const lng = EXIF.getTag(this, 'GPSLongitude');
              const latRef = EXIF.getTag(this, 'GPSLatitudeRef');
              const lngRef = EXIF.getTag(this, 'GPSLongitudeRef');

              if (lat && lng && latRef && lngRef) {
                // Convert coordinates to decimal
                const latitude = toDecimal(lat, latRef);
                const longitude = toDecimal(lng, lngRef);

                // Set the values to the form fields
                document.querySelector('#latitude').value = latitude;
                document.querySelector('#longitude').value = longitude;
                console.log('Latitude: ' + latitude + ' Longitude: ' + longitude);
              } else {
                // Handle the case when GPS data is not available in the image
                console.log('No GPS data found in the file');
              }
            });
          });
        });

        function toDecimal(coord, ref) {
          const [degrees, minutes, seconds] = coord;
          let decimal = degrees + minutes / 60 + seconds / (60 * 60);

          if (ref === 'S' || ref === 'W') {
            decimal = -decimal;
          }

          return decimal;
        }

        const steps = document.querySelectorAll('.step');
        const step1Next = document.getElementById('step1Next');
        const step2Prev = document.getElementById('step2Prev');
        const step2Next = document.getElementById('step2Next');
        const step3Prev = document.getElementById('step3Prev');

        function showStep(index) {
          steps.forEach((step, i) => {
            step.classList.toggle('hidden', i !== index);
          });
        }

        step1Next.addEventListener('click', () => showStep(1));
        step2Prev.addEventListener('click', () => showStep(0));
        step2Next.addEventListener('click', () => showStep(2));
        step3Prev.addEventListener('click', () => showStep(1));

        function autoCompleteData(inputField, zipCode, city, district, country) {
          var inputs = ['zip_code', 'city', 'district', 'country'];

          for (const id of inputs) {
            if (inputField.id === id) continue;
            let fieldValue = null;

            switch (id) {
              case 'zip_code':
                fieldValue = zipCode;
                break;
              case 'city':
                fieldValue = city;
                break;
              case 'district':
                fieldValue = district;
                break;
              case 'country':
                fieldValue = country;
                break;
            }

            document.getElementById(id).value = fieldValue || '';
          }
        }

        function getAutoCompleteData(inputField) {
          var query = inputField.value;
          if (query) {
            fetch('/autocomplete?q=' + query)
              .then(response => response.json())
              .then(data => {
                if (data.length > 0) {
                  var firstResult = data[0];
                  autoCompleteData(inputField, firstResult.plz, firstResult.ort, firstResult.landkreis, firstResult.bundesland);
                }
              });
          }
        }

        document.addEventListener('DOMContentLoaded', function () {
          var zipCodeInput = document.getElementById('zip_code');

          function addEvents(inputField) {
            inputField.addEventListener('keydown', function (event) {
              if (event.key === 'Enter' || event.key === 'Tab') {
                if (inputField.value.length >= 4) {
                  getAutoCompleteData(inputField);
                }
              }
            });
            inputField.addEventListener('blur', function () {
              if (inputField.value.length >= 5) {
                getAutoCompleteData(inputField);
              }
            });
            //if input field is empty, clear all other fields related to it
            inputField.addEventListener('input', function () {
              if (inputField.value === '') {
                autoCompleteData(inputField, '', '', '', '');
              }
            });
          }

          addEvents(zipCodeInput);
        });
      </script>
      <!-- (Existing JavaScript code) -->
    </div>
  </div>
</body>

{% endblock content %}