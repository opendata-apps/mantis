{% extends "layout.html" %}
{% from "macro.html" import popover %}
{% block head %}
<script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
{% endblock %}
{% block title %}Report{% endblock %}
{% block content %}

<body>
  <div class="flex items-center min-h-screen bg-gray-100">
    <div class="w-full max-w-4xl p-6 mx-auto bg-white rounded-lg shadow-xl">
      <form action="" method="POST" enctype="multipart/form-data" id="mainForm">

        <!-- User Input and Location Input Step Start-->
        <div id="step1" class="step">
          {{ form.hidden_tag() }}
          <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
            <div>
	      <div class="flex justify-between">
		{{ form.picture.label.text }}
		<button data-popover-target="popover-picture"
			type="button"
			class="text-black pl-10 pr-2">?</button>
	      </div>
              <div data-popover id="popover-picture"
		   role="tooltip"
		   class="absolute z-10 invisible inline-block
			  w-64 text-sm text-gray-500 transition-opacity duration-300
			  bg-white border border-gray-200 rounded-lg shadow-sm opacity-0
			  dark:text-gray-400 dark:border-gray-600 dark:bg-gray-800">
                <div
                  class="px-3 py-2 bg-gray-100 border-b border-gray-200 rounded-t-lg
			 dark:border-gray-600 dark:bg-gray-700">
                  <h3 class="font-semibold text-gray-900 dark:text-white">Info zum Bild-Upload</h3>
                </div>
                <div class="px-3 py-2">
                  <p>
		    Anhand des Bildes können wir Ihre Bestimmung
                    überprüfen. Ist ihr Fund von uns überprüft und
                    freigegeben erscheint er in der Karte. Die Bilder
                    werden nicht weiterverwendet. Ihre Uhrheberrechte
                    bleiben unberührt
		  </p>
                </div>
              </div>
              <div class="relative">
                {{ form.picture(class="block w-full mt-1 text-sm text-gray-900 border
		border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none ",
		id=form.picture.id, accept="image/*", capture="user")
                }}


                </div>
              </label>

              <p class="mt-1 text-sm text-gray-500" id="{{ form.picture.id }}_help">
                {{ form.picture.description }}
              </p>
            </div>
            <div>
              <label class="block text-sm font-semibold text-gray-600">
		
                {{ form.gender.label.text }}

                <div class="relative">
                  {{ form.gender(class="w-full p-2 mt-1 bg-white border rounded-md focus:outline-none focus:ring-1
                  focus:ring-green-500") }}
                </div>
              </label>
            </div>
            <div>
	      <label class="text-sm font-semibold text-gray-600">
		<div class="flex justify-between">
                  <div>{{ form.longitude.label.text }}</div>
		  <button data-popover-target="popover-longitude"
			  type="button"
			  class="text-black pl-10 pr-2">?</button>
		</div>
		<div data-popover id="popover-longitude"
		     role="tooltip"
		     class="absolute z-10 invisible inline-block w-64 text-sm text-gray-500
			    transition-opacity duration-300 bg-white border border-gray-200 rounded-lg
			    shadow-sm opacity-0 dark:text-gray-400 dark:border-gray-600 dark:bg-gray-800">
		  <div
		    class="px-3 py-2 bg-gray-100 border-b border-gray-200 rounded-t-lg
			   dark:border-gray-600 dark:bg-gray-700">
		    <h3 class="font-semibold text-gray-900 dark:text-white">Koordinaten</h3>
		  </div>
		  <div class="px-3 py-2">
		    <p>
		      Der Längengrad wird automatisch angegeben sobald sie den Marker
		      an der unterstehenden Karte setzen.</p>
		  </div>  
		</div>
		<div class="relative">
		  {{ form.longitude(placeholder="z.B. 13.12345",
		  class="w-full p-2 mt-1 bg-white border rounded-md
		  focus:outline-none focus:ring-1 focus:ring-green-500") }}
		  
		</div>
	      </label>
              <label class="block text-sm font-semibold text-gray-600">
		<div class="flex justify-between">
		    {{ form.latitude.label.text }}
		    <button data-popover-target="popover-latitude"
			    type="button"
			    class="text-black pl-10 pr-2">?</button>
		</div>
                <div data-popover
		     id="popover-latitude"
		     role="tooltip"
		     class="absolute z-10 invisible inline-block w-64 text-sm t
			    ext-gray-500 transition-opacity duration-300 bg-white
			    border border-gray-200 rounded-lg shadow-sm opacity-0
			    dark:text-gray-400 dark:border-gray-600 dark:bg-gray-800">
                  <div class="px-3 py-2 bg-gray-100 border-b border-gray-200
			      rounded-t-lg dark:border-gray-600 dark:bg-gray-700">
                    <h3 class="font-semibold text-gray-900 dark:text-white">Koordinaten</h3>
                  </div>
                  <div class="px-3 py-2">
                    <p>
		      Der Breitengrad wird automatisch angegeben sobald
		      Sie den Marker an der unterstehenden Karte setzen.
		    </p>
                  </div>
                </div>


                <div class="relative">
                  {{ form.latitude(placeholder="z.B. 52.12345",
		  class="w-full p-2 mt-1 bg-white border rounded-md
                  focus:outline-none focus:ring-1 focus:ring-green-500") }}
                 

                </div>
              </label>
            </div>
            <div>
              <label class="block text-sm font-semibold text-gray-600">
		<div class="flex justify-between">
                  {{ form.zip_code.label.text }}
		  <button data-popover-target="popover-zip"
			  type="button"
			  class="text-black pl-10 pr-2">?</button>
		</div>
                <div data-popover
		     id="popover-zip"
		     role="tooltip"
		     class="absolute z-10 invisible inline-block
                            w-64 text-sm text-gray-500 transition-opacity duration-300
			    bg-white border border-gray-200 rounded-lg shadow-sm opacity-0
			    dark:text-gray-400 dark:border-gray-600 dark:bg-gray-800">
                  <div
                    class="px-3 py-2 bg-gray-100 border-b border-gray-200 rounded-t-lg
			   dark:border-gray-600 dark:bg-gray-700">
                    <h3 class="font-semibold text-gray-900 dark:text-white">Postleitzahl</h3>
                  </div>
                  <div class="px-3 py-2">
                    <p>
		      Falls der Wert nicht korrekt eingelesen wurde, geben Sie bitte die Postleitzahl ein.
		    </p>
                  </div>
                </div>

                <div class="relative">
                  {{ form.zip_code(id="zip_code",
		  placeholder="z.B. 10115",
		  class="w-full p-2 mt-1 bg-white border
                  rounded-md focus:outline-none focus:ring-1 focus:ring-green-500") }}

                </div>
              </label>
              <label class="block text-sm font-semibold text-gray-600">
		<div class="flex justify-between">
                  {{ form.city.label.text }}
		  <button data-popover-target="popover-city"
			  type="button"
			  class="text-black pl-10 pr-2">?</button>
		</div>
                <div data-popover
		     id="popover-city"
		     role="tooltip"
		     class="absolute z-10 invisible inline-block w-64 text-sm text-gray-500
			    transition-opacity duration-300 bg-white border border-gray-200 rounded-lg
                            shadow-sm opacity-0 dark:text-gray-400 dark:border-gray-600 dark:bg-gray-800">
                  <div
                    class="px-3 py-2 bg-gray-100 border-b border-gray-200 rounded-t-lg dark:border-gray-600 dark:bg-gray-700">
                    <h3 class="font-semibold text-gray-900 dark:text-white">Ort</h3>
                  </div>
                  <div class="px-3 py-2">
                    <p>
		      Falls der Wert nicht korrekt eingelesen wurde, geben Sie bitte den Stadtnamen ein.
		    </p>
                  </div>
                </div>

                <div class="relative">
                  {{ form.city(id="city",
		  placeholder="z.B. Berlin",
		  class="w-full p-2 mt-1 bg-white border rounded-md
                  focus:outline-none focus:ring-1 focus:ring-green-500") }}

                </div>

              </label>
            </div>
            <div>
              <label class="block text-sm font-semibold text-gray-600">
		<div class="flex justify-between">
                    {{ form.street.label.text }}
		    <button data-popover-target="popover-street"
			    type="button"
			    class="text-black pl-10 pr-2">?</button>
		</div>
                <div data-popover id="popover-street"
		     role="tooltip"
		     class="absolute z-10 invisible inline-block w-64 text-sm text-gray-500
			    transition-opacity duration-300 bg-white border border-gray-200 rounded-lg
                            shadow-sm opacity-0 dark:text-gray-400 dark:border-gray-600 dark:bg-gray-800">
                  <div
                    class="px-3 py-2 bg-gray-100 border-b border-gray-200 rounded-t-lg
			   dark:border-gray-600 dark:bg-gray-700">
                    <h3 class="font-semibold text-gray-900 dark:text-white">Straße</h3>
                  </div>
                  <div class="px-3 py-2">
                    <p>
		      Falls der Wert nicht korrekt eingelesen wurde, geben Sie bitte den Straßennamen ein.
		    </p>
                  </div>
                </div>
                <div class="relative">
                  {{ form.street(placeholder="z.B. Musterstraße",
		  class="w-full p-2 mt-1 bg-white border rounded-md
                  focus:outline-none focus:ring-1 focus:ring-green-500") }}

                </div>
              </label>
              <label class="block text-sm font-semibold text-gray-600">
		<div class="flex justify-between">
                  {{ form.state.label.text }}
		  <button data-popover-target="popover-bundesland"
			  type="button"
			  class="text-black pl-10 pr-2">?</button>
		</div>
                <div data-popover
		     id="popover-bundesland"
		     role="tooltip"
		     class="absolute z-10 invisible inline-block w-64 text-sm text-gray-500
			    transition-opacity duration-300 bg-white border border-gray-200 rounded-lg
                            shadow-sm opacity-0 dark:text-gray-400 dark:border-gray-600 dark:bg-gray-800">
                  <div
                    class="px-3 py-2 bg-gray-100 border-b border-gray-200
			   rounded-t-lg dark:border-gray-600 dark:bg-gray-700">
                    <h3 class="font-semibold text-gray-900 dark:text-white">Bundesland</h3>
                  </div>
                  <div class="px-3 py-2">
                    <p>Falls der Wert nicht korrekt eingelesen wurde, geben Sie bitte den Bundeslandnamen ein.</p>
                  </div>
                </div>


                <div class="relative">
                  {{ form.state(id="state",
		  placeholder="z.B. Berlin",
		  class="w-full p-2 mt-1 bg-white border rounded-md
                  focus:outline-none focus:ring-1 focus:ring-green-500") }}

                </div>
              </label>
              <label class="block text-sm font-semibold text-gray-600">
		<div class="flex justify-between">
                  {{ form.district.label.text }}
		  <button data-popover-target="popover-bezirk"
			  type="button"
			  class="text-black pl-10 pr-2">?</button>
		</div>
                <div data-popover
		     id="popover-bezirk"
		     role="tooltip"
		     class="absolute z-10 invisible inline-block w-64 text-sm text-gray-500
			    transition-opacity duration-300 bg-white border border-gray-200 rounded-lg
                            shadow-sm opacity-0 dark:text-gray-400 dark:border-gray-600 dark:bg-gray-800">
                  <div
                    class="px-3 py-2 bg-gray-100 border-b border-gray-200
			   rounded-t-lg dark:border-gray-600 dark:bg-gray-700">
                    <h3 class="font-semibold text-gray-900 dark:text-white">Landkreis/Stadt</h3>
                  </div>
                  <div class="px-3 py-2">
                    <p>
		      Falls der Wert nicht korrekt eingelesen wurde,
		      geben Sie bitte den Landkreis/die Stadt ein.
		    </p>
                  </div>
                </div>
                <div class="relative">
                  {{ form.district(id="district",
		  placeholder="z.B. Mitte",
		  class="w-full p-2 mt-1 bg-white border
                  rounded-md focus:outline-none focus:ring-1 focus:ring-green-500") }}

                </div>
              </label>
            </div>
            <div>
              <div>
                <label class="block text-sm font-semibold text-gray-600">
		  <div class="flex justify-between">
                    {{ form.picture_description.label.text }}
		    <button data-popover-target="popover-beschreibung"
			    type="button"
			    class="text-black pl-10 pr-2">?</button>
		  </div>
                  <div data-popover
		       id="popover-beschreibung"
		       role="tooltip"
		       class="absolute z-10 invisible inline-block w-64 text-sm text-gray-500
			      transition-opacity duration-300 bg-white border border-gray-200 rounded-lg
                              shadow-sm opacity-0 dark:text-gray-400 dark:border-gray-600 dark:bg-gray-800">
                    <div
                      class="px-3 py-2 bg-gray-100 border-b border-gray-200
			     rounded-t-lg dark:border-gray-600 dark:bg-gray-700">
                      <h3 class="font-semibold text-gray-900 dark:text-white">Ergänzungen zum Fund</h3>
                  </div>
                  <div class="px-3 py-2">
                    <p>Ergänzende Angaben zum Bild <br/> (maximal 500 Zeichen)</p>
                  </div>
                </div>
                  
                  <div class="relative">
                    {{ form.picture_description(placeholder="Geben Sie hier Ihre Bildbeschreibung ein",
		    class="w-full p-2 mt-1 whitespace-pre-wrap bg-white
		    border rounded-md focus:outline-none focus:ring-1 focus:ring-green-500") }}
                  </div>
                </label>
                <span id="charCount" class="text-xs text-right text-gray-500"></span>
              </div>
              <div>
                <label class="block mt-10 text-sm font-semibold text-gray-600">
		  <div class="flex justify-between">
                    {{ form.location_description.label.text }}
		    <button data-popover-target="popover-fundort"
			    type="button"
			    class="text-black pl-10 pr-2">?</button>
		    </div>
                  <div data-popover
		       id="popover-fundort"
		       role="tooltip"
		       class="absolute z-10 invisible inline-block w-64 text-sm text-gray-500
			      transition-opacity duration-300 bg-white border border-gray-200 rounded-lg
                              shadow-sm opacity-0 dark:text-gray-400 dark:border-gray-600 dark:bg-gray-800">
                    <div class="px-3 py-2 bg-gray-100 border-b border-gray-200
				rounded-t-lg dark:border-gray-600 dark:bg-gray-700">
                      <h3 class="font-semibold text-gray-900 dark:text-white">Ergänzungen Ort</h3>
                    </div>
                    <div class="px-3 py-2">
                      <p>
			Beschreiben Sie hier bitte den Ort etwas genauer <br/>(maximal 500 Zeichen)
		      </p>
                    </div>
                  </div>
    
                  <div class="relative">
                    {{ form.location_description(placeholder="Geben Sie hier Ihre Ortsbeschreibung ein",
		    class="w-full p-2 mt-1 whitespace-pre-wrap bg-white border rounded-md
		    focus:outline-none focus:ring-1 focus:ring-green-500") }}
                  </div>
                </label>
              </div>
            </div>
            <div class="col-span-full">
              <div id="map"
		   class="h-64 border shadow-md sm:h-96 lg:h-96">
	      </div>
            </div>
          </div>
          <div class="flex justify-end mt-4 space-x-2">
            <button type="button" id="step1Next"
		    class="w-full px-6 py-2 text-sm font-medium leading-5 text-center text-white
			   transition-colors duration-150 bg-green-500 border border-transparent
			   rounded-lg hover:bg-green-600 focus:outline-none md:w-auto">
              Next
            </button>
          </div>
        </div>
        <!-- User Input and Location Input Step End-->

        <!-- Melderinfo Step Start-->
        <div id="step3" class="hidden step">
          <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
            <div>
              <label class="block text-sm font-semibold text-gray-600">
		<div class="flex justify-between">
		    {{ form.first_name.label.text }}
		    <button data-popover-target="popover-vorname"
			    type="button"
			    class="text-black pl-10 pr-2">?</button>
		</div>
		<div data-popover
		     id="popover-vorname"
		     role="tooltip"
		     class="absolute z-10 invisible inline-block w-64 text-sm t
			    ext-gray-500 transition-opacity duration-300 bg-white
			    border border-gray-200 rounded-lg shadow-sm opacity-0
			    dark:text-gray-400 dark:border-gray-600 dark:bg-gray-800">
                  <div class="px-3 py-2 bg-gray-100 border-b border-gray-200
			      rounded-t-lg dark:border-gray-600 dark:bg-gray-700">
                    <h3 class="font-semibold text-gray-900 dark:text-white">Vorname</h3>
                  </div>
                  <div class="px-3 py-2">
                    <p>
		      Geben Sie bitte Ihren ersten Buchstaben des Vornamens ein.
		      Beispiel: M. für Max
		    </p>
                  </div>
                </div>
		
                <div class="relative">
                  {{ form.first_name(placeholder="Erster Buchstabe z.B. M.",
		  class="w-full p-2 mt-1 bg-white border
                  rounded-md focus:outline-none focus:ring-1 focus:ring-green-500") }}
                </div>
              </label>

              <label class="block text-sm font-semibold text-gray-600">
		<div class="flex justify-between">
                  {{ form.last_name.label.text }}
		  <button data-popover-target="popover-nachname"
			  type="button"
			  class="text-black pl-10 pr-2">?</button>
		</div>
                <div data-popover
		     id="popover-nachname"
		     role="tooltip"
		     class="absolute z-10 invisible inline-block w-64 text-sm t
			    ext-gray-500 transition-opacity duration-300 bg-white
			    border border-gray-200 rounded-lg shadow-sm opacity-0
			    dark:text-gray-400 dark:border-gray-600 dark:bg-gray-800">
                  <div class="px-3 py-2 bg-gray-100 border-b border-gray-200
			      rounded-t-lg dark:border-gray-600 dark:bg-gray-700">
                    <h3 class="font-semibold text-gray-900 dark:text-white">Nachname</h3>
                  </div>
                  <div class="px-3 py-2">
                    <p>
		      Geben Sie hier bitte Ihren Nachnamen ein.
		    </p>
                  </div>
                </div>		  
                  <div class="relative">
                    {{ form.last_name(placeholder="z.B. Mustermann",
		    class="w-full p-2 mt-1 bg-white border rounded-md
                    focus:outline-none focus:ring-1 focus:ring-green-500") }}
                </div>
              </label>
            </div>
            <div>
              <label class="block text-sm font-semibold text-gray-600">
		<div class="flex justify-between">
                  {{ form.sighting_date.label.text }}
		  <button data-popover-target="popover-datum"
			  type="button"
			  class="text-black pl-10 pr-2">?</button>
		</div>
                <div data-popover
		     id="popover-datum"
		     role="tooltip"
		     class="absolute z-10 invisible inline-block w-64 text-sm t
			    ext-gray-500 transition-opacity duration-300 bg-white
			    border border-gray-200 rounded-lg shadow-sm opacity-0
			    dark:text-gray-400 dark:border-gray-600 dark:bg-gray-800">
                  <div class="px-3 py-2 bg-gray-100 border-b border-gray-200
			      rounded-t-lg dark:border-gray-600 dark:bg-gray-700">
                    <h3 class="font-semibold text-gray-900 dark:text-white">Datum</h3>
                  </div>
                  <div class="px-3 py-2">
                    <p>
		      Wählen Sie hier bitte das Funddatum.
		    </p>
                  </div>
                </div>
		  
                <div class="relative">
                  {{ form.sighting_date(placeholder="z.B. 2023-05-14",
		  class="w-full p-2 mt-1 bg-white border rounded-md
                  focus:ring-green-500") }}
                </div>
              </label>
              <label class="block text-sm font-semibold text-gray-600">
		<div class="flex justify-between">
                  {{ form.contact.label.text }}
		  <button data-popover-target="popover-kontakt"
			    type="button"
			    class="text-black pl-10 pr-2">?</button>
		</div>
                <div data-popover
		     id="popover-kontakt"
		     role="tooltip"
		     class="absolute z-10 invisible inline-block w-64 text-sm t
			    ext-gray-500 transition-opacity duration-300 bg-white
			    border border-gray-200 rounded-lg shadow-sm opacity-0
			    dark:text-gray-400 dark:border-gray-600 dark:bg-gray-800">
                  <div class="px-3 py-2 bg-gray-100 border-b border-gray-200
			      rounded-t-lg dark:border-gray-600 dark:bg-gray-700">
                    <h3 class="font-semibold text-gray-900 dark:text-white">Kontaktdaten</h3>
                  </div>
                  <div class="px-3 py-2">
                    <p>
		      Möchten sie eine Rückmeldung und eine
                      Bestätigung ihrer bestimmung erhalten, hinterlassen
                      Sie gerne Ihre E-Mail. Ihre Kontaktdaten werden
                      geschützt, nicht weitergegeben oder anderweitig
                      verwendet
		    </p>
                  </div>
                </div>
                <div class="relative">
                  {{ form.contact(placeholder="z.B. max@example.de",
		  class="w-full p-2 mt-1 bg-white border rounded-md
                  focus:outline-none focus:ring-1 focus:ring-green-500") }}
                </div>
              </label>
            </div>
          </div>

          <div class="flex justify-between mt-4 space-x-2">
            <button type="button" id="step2Prev"
              class="w-full px-6 py-2 text-sm font-medium leading-5 text-center text-white transition-colors duration-150 bg-green-500 border border-transparent rounded-lg hover:bg-green-600 focus:outline-none md:w-auto">
              Prev
            </button>
            <button type="submit"
              class="w-full px-6 py-2 text-sm font-medium leading-5 text-center text-white transition-colors duration-150 bg-green-500 border border-transparent rounded-lg hover:bg-green-600 focus:outline-none md:w-auto">
              Submit
            </button>
          </div>
        </div>
        <!-- Melderinfo Step End-->
      </form>
    </div>
  </div>
</body>

<script>


  let map;
  // Add Leaflet map configuration and event handling
  function initMap() {
    map = L.map('map').setView([52.5200, 13.4050], 5);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      maxZoom: 18,
    }).addTo(map);

    let userMarker;

    // Update form fields on map click
    map.on('click', function (e) {
      document.querySelector('#latitude').value = e.latlng.lat.toFixed(5);
      document.querySelector('#longitude').value = e.latlng.lng.toFixed(5);

      getAddressFromCoordinates(e.latlng.lat, e.latlng.lng);

      if (userMarker) {
        userMarker.remove();
      }

      userMarker = L.marker([e.latlng.lat, e.latlng.lng]).addTo(map);
    });
  }
  document.addEventListener('DOMContentLoaded', initMap);

  function getAddressFromCoordinates(latitude, longitude) {
    const nominatimUrl = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&zoom=18&addressdetails=1`;

    fetch(nominatimUrl)
      .then(response => response.json())
      .then(data => {
        const address = data.address;
        document.querySelector("#zip_code").value = address.postcode || "";
        document.querySelector("#city").value = address.city || "";
        document.querySelector("#street").value = `${address.road || ""} ${address.house_number || ""}`.trim();
        document.querySelector("#state").value = address.state || "";
        document.querySelector("#district").value = address.suburb || "";
        console.log("Address data:", address);
      })
      .catch(error => {
        console.error("Error fetching address data:", error);
      });
  }

  function saveFormDataToLocalStorage() {
    const form = document.getElementById('mainForm');
    const formData = new FormData(form);

    for (const [key, value] of formData.entries()) {
      localStorage.setItem(key, value);
    }
  }

  function loadFormDataFromLocalStorage() {
    const form = document.getElementById('mainForm');

    for (const input of form.elements) {
      if (input.name && input.type !== 'file') {
        const value = localStorage.getItem(input.name);
        if (value) {
          try {
            input.value = value;
          } catch (e) {
            console.error('Error setting input value:', e);
          }
        }
      }
    }
  }


  // Call this function when the page loads to load saved form data.
  document.addEventListener('DOMContentLoaded', loadFormDataFromLocalStorage);

  // Call this function to save form data to local storage when any input changes.
  document.getElementById('mainForm').addEventListener('input', saveFormDataToLocalStorage);

  document.addEventListener('DOMContentLoaded', function () {
    const pictureInput = document.querySelector('#picture');

    pictureInput.addEventListener('change', function (event) {
      const file = event.target.files[0];
      if (!file) return;

      EXIF.getData(file, function () {
        // Read metadata from the image
        const lat = EXIF.getTag(this, 'GPSLatitude');
        const lng = EXIF.getTag(this, 'GPSLongitude');
        const latRef = EXIF.getTag(this, 'GPSLatitudeRef');
        const lngRef = EXIF.getTag(this, 'GPSLongitudeRef');

        if (lat && lng && latRef && lngRef) {
          // Convert coordinates to decimal
          const latitude = toDecimal(lat, latRef);
          const longitude = toDecimal(lng, lngRef);

          // Set the values to the form fields
          document.querySelector('#latitude').value = latitude;
          document.querySelector('#longitude').value = longitude;
          console.log('Latitude: ' + latitude + ' Longitude: ' + longitude);

          getAddressFromCoordinates(latitude, longitude);
        } else {
          // Handle the case when GPS data is not available in the image
          console.log('No GPS data found in the file');
        }
      });
    });
  });

  function toDecimal(coord, ref) {
    const [degrees, minutes, seconds] = coord;
    let decimal = degrees + minutes / 60 + seconds / (60 * 60);

    if (ref === 'S' || ref === 'W') {
      decimal = -decimal;
    }

    return decimal;
  }

  const steps = document.querySelectorAll('.step');
  const step1Next = document.getElementById('step1Next');
  const step2Prev = document.getElementById('step2Prev');

  function showStep(index) {
    steps.forEach((step, i) => {
      step.classList.toggle('hidden', i !== index);
    });

    // When showing the map, invalidate the size and slightly delay the map resize
    if (index === 1) {
      setTimeout(() => {
        map.invalidateSize();
      }, 100);
    }
  }

  step1Next.addEventListener('click', () => showStep(1));
  step2Prev.addEventListener('click', () => showStep(0));

  function autoCompleteData(inputField, zipCode, city, district, state) {
    var inputs = ['zip_code', 'city', 'district', 'state'];

    for (const id of inputs) {
      if (inputField.id === id) continue;
      let fieldValue = null;

      switch (id) {
        case 'zip_code':
          fieldValue = zipCode;
          break;
        case 'city':
          fieldValue = city;
          break;
        case 'district':
          fieldValue = district;
          break;
        case 'state':
          fieldValue = state;
          break;
      }

      document.getElementById(id).value = fieldValue || '';
    }
  }

  function getAutoCompleteData(inputField) {
    var query = inputField.value;
    if (query) {
      fetch('/autocomplete?q=' + query)
        .then(response => response.json())
        .then(data => {
          if (data.length > 0) {
            var firstResult = data[0];
            autoCompleteData(inputField, firstResult.plz, firstResult.ort, firstResult.landkreis, firstResult.bundesland);
          }
        });
    }
  }

  document.addEventListener('DOMContentLoaded', function () {
    var zipCodeInput = document.getElementById('zip_code');

    function addEvents(inputField) {
      inputField.addEventListener('keydown', function (event) {
        if (event.key === 'Enter' || event.key === 'Tab') {
          if (inputField.value.length >= 4) {
            getAutoCompleteData(inputField);
          }
        }
      });
      inputField.addEventListener('blur', function () {
        if (inputField.value.length >= 5) {
          getAutoCompleteData(inputField);
        }
      });
      //if input field is empty, clear all other fields related to it
      inputField.addEventListener('input', function () {
        if (inputField.value === '') {
          autoCompleteData(inputField, '', '', '', '');
        }
      });
    }

    addEvents(zipCodeInput);
  });

  // Character Counter for Picture Description on load
  const inputField = document.querySelector("#{{ form.picture_description.id }}");
  const charCountElement = document.querySelector("#charCount");

  function updateCharCount() {
    const charCount = inputField.value.length;
    charCountElement.textContent = `(${charCount}/500)`;
  }

  inputField.addEventListener("input", updateCharCount);

  // Display counter on load
  updateCharCount();
  // Character Counter for Picture Description

  // Step 1 Validation
  const GENDER_CHOICES = [
    ['', 'Bitte auswählen'],
    ['keine Zuoordnung', 'Keine Zuordnung']
    ['männchen', 'Männchen'],
    ['weibchen', 'Weibchen'],
    ['nymphen', 'Nymphen'],
    ['ootheken', 'Ootheken']
  ];

  const ALLOWED_EXTENSIONS = ['png', 'jpg', 'jpeg', 'gif', 'tif', 'tiff', 'bmp', 'jfif', 'webp', 'svg', 'svgz', 'ico'];

  function validateStep1() {
    const picture = document.querySelector('#picture').files[0];
    const allowedTypes = ['png', 'jpg', 'jpeg', 'gif', 'tif', 'tiff', 'bmp', 'jfif', 'webp', 'svg', 'svgz', 'ico'];
    const allowedSize = 5 * 1024 * 1024;
    const fileName = picture ? picture.name.toLowerCase() : '';

    // Überprüfen, ob das Bildfeld ausgefüllt wurde und eine gültige Datei ausgewählt wurde
    if (!picture) {
      alert('Bitte wählen Sie ein Bild aus.');
      return false;
    } else if (!allowedTypes.includes(fileName.split('.').pop()) || picture.size > allowedSize) {
      alert('Bitte geben Sie eine gültige Bilddatei ein, die kleiner als 5 MB ist und eine der folgenden Erweiterungen hat: PNG, JPG, JPEG oder GIF.')
      return false;
    } else {
      const gender = document.querySelector('#gender').value;

      // Überprüfen, ob das Geschlecht ausgefüllt wurde und ob es ein gültiger Wert ist
      if (gender === '') {
        alert('Bitte wählen Sie ein Entwicklungsstadium aus.');
        return false;
      }

      return true;
    }
  }
  // Ändern Sie den Event-Listener, um die Pflichtfeldüberprüfung durchzuführen
  step1Next.addEventListener('click', () => {
    if (validateStep1()) {
      showStep(1);
    }
  });
        // Step 1 Validation


</script>
</div>
</div>
</body>

{% endblock content %}
