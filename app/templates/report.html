{% extends "layout.html" %}
{% from "macro.html" import popover %}
{% block head %}
<script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
{% endblock %}
{% block title %}Report{% endblock %}
{% block content %}
{% with messages = get_flashed_messages() %}
{% if messages %}
{% for message in messages %}
<div id="toast-interactive-{{ loop.index }}"
  class="fixed z-50 max-w-2xl px-4 py-2 text-gray-500 transform -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg shadow toast dark:bg-gray-800 dark:text-gray-400 top-1/4 left-1/2 min-h-16"
  role="alert">
  <div class="flex">
    <div
      class="inline-flex items-center justify-center flex-shrink-0 w-8 h-8 text-green-500 bg-green-100 rounded-lg dark:text-green-300 dark:bg-green-900">
      <span class="sr-only">Notification icon</span>
    </div>
    <div class="ml-3 text-sm font-normal">
      <p class="mb-1 text-sm font-semibold text-gray-900 break-all dark:text-white">{{ message.title }}</p>
      <p class="text-gray-800 dark:text-gray-400">{{ message.message }}</p>
      <pre class="overflow-x-auto font-mono text-xs text-gray-800 dark:text-gray-400">{{ message.usrid }}</pre>
      <div class="grid grid-cols-2 gap-2 mt-2">
        <div>
          <a href="/report"
            class="inline-flex justify-center w-full px-2 py-1.5 text-xs font-medium text-center text-white bg-green-600 rounded-lg hover:bg-green-700 focus:ring-4 focus:outline-none focus:ring-blue-300 ">Report
            Mantis</a>
        </div>
        <div>
          <button onclick="copyToClipboard('{{ message.usrid }}')" title="Copy User ID"
            class="inline-flex justify-center w-full px-2 py-1.5 text-xs font-medium text-center text-gray-900 bg-white border border-gray-300 rounded-lg hover:bg-gray-100 focus:ring-4 focus:outline-none focus:ring-gray-200 ">Copy
            ID</button>
        </div>
      </div>
    </div>
    <button type="button"
      class="ml-auto -mx-1.5 -my-1.5 bg-white text-gray-400 hover:text-gray-900 rounded-lg focus:ring-2 focus:ring-gray-300 p-1.5 hover:bg-gray-100 inline-flex h-8 w-8 "
      data-dismiss-target="#toast-interactive-{{ loop.index }}" aria-label="Close">
      <span class="sr-only">Close</span>
      <svg aria-hidden="true" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"
        xmlns="http://www.w3.org/2000/svg">
        <path fill-rule="evenodd"
          d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
          clip-rule="evenodd"></path>
      </svg>
    </button>
  </div>
</div>
{% endfor %}
{% endif %}
{% endwith %}

<div class="flex items-center min-h-screen bg-gray-100">
  <div class="w-full max-w-4xl p-6 mx-auto bg-white rounded-lg shadow-xl">
    <form action="" method="POST" enctype="multipart/form-data" id="mainForm">
      {{ form.hidden_tag() }}
       <!-- Step 1: Bild-Upload -->

      <div id="step1" class="step">
         <div class="mb-4">
          <div class="flex justify-between">
            {{ form.picture.label.text }}
            {{ popover("popover-picture", "Info zum Bild-Upload",
            "Anhand des Bildes können wir Ihre Bestimmung überprüfen. Ist Ihr Fund von uns überprüft und freigegeben,
            erscheint er in der Karte. Die Bilder werden nicht weiterverwendet. Ihre Urheberrechte bleiben
            unberührt.") }}
          </div>
          <div class="flex items-center justify-center w-full">
            <label for="{{ form.picture.id }}"
              class="flex flex-col items-center justify-center w-full h-64 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 dark:hover:bg-bray-800 dark:bg-gray-700 hover:bg-gray-100 dark:border-gray-600 dark:hover:border-gray-500 dark:hover:bg-gray-600">
              <div id="imagePreview" class="flex-col items-center justify-center hidden w-full h-64 overflow-hidden">
                <img id="previewImage" class="object-scale-down w-full h-full" src="#" alt="Preview">
              </div>
              <div id="uploadText" class="flex flex-col items-center justify-center pt-5 pb-6">
                <svg aria-hidden="true" class="w-10 h-10 mb-3 text-gray-400" fill="none" stroke="currentColor"
                  viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                </svg>
                <p class="mb-2 text-sm text-gray-500 dark:text-gray-400"><span class="font-semibold">Klick, um Bild zu 
                    laden ...</span></p>
                <p class="text-xs text-gray-500 dark:text-gray-400"> PNG JPG JPEG oder WEBP (MAX. 800x400px)</p>
              </div>
              {{ form.picture(class="hidden", id=form.picture.id, accept="image/*") }}
            </label>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-4">
          <div>
            <label for="{{ form.longitude.id }}" class="block text-sm font-semibold text-gray-600">
              <div class="flex justify-between">
                {{ form.longitude.label.text }}
                {{ popover("popover-longitude", "Koordinaten",
                "Der Längengrad wird automatisch angegeben, sobald Sie den Marker an der untenstehenden Karte setzen.")
                }}
              </div>
              <div class="relative">
                {{ form.longitude(placeholder="z.B. 13.12345", class="input-field") }}
              </div>
            </label>
          </div>
          <div>
            <label for="{{ form.latitude.id }}" class="block text-sm font-semibold text-gray-600">
              <div class="flex justify-between">
                {{ form.latitude.label.text }}
                {{ popover("popover-latitude", "Koordinaten",
                "Der Breitengrad wird automatisch angegeben, sobald Sie den Marker an der untenstehenden Karte setzen.")
                }}
              </div>
              <div class="relative">
                {{ form.latitude(placeholder="z.B. 52.12345", class="input-field") }}
              </div>
            </label>
          </div>
        </div>

        <div class="col-span-full">
          <div id="map" class="h-64 border shadow-md sm:h-96 lg:h-96"></div>
        </div>

        <div class="flex justify-end mt-4 space-x-2">
          <button type="button" id="step1Next"
            class="w-full px-6 py-2 text-sm font-medium leading-5 text-center text-white transition-colors duration-150 bg-green-500 border border-transparent rounded-lg hover:bg-green-600 focus:outline-none md:w-auto">
            Next
          </button>
        </div>
      </div>


      <!-- Step 2: Beschreibung Ort und Fund -->
      <div id="step2" class="hidden step">
        <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
          <div>
            <label for="{{ form.street.id }}" class="block text-sm font-semibold text-gray-600">
              <div class="flex justify-between">
                {{ form.street.label.text }}
                {{ popover("popover-street", "Straße",
                "Falls der Wert nicht korrekt eingelesen wurde, geben Sie bitte den Straßennamen ein.") }}
              </div>
              <div class="relative">
                {{ form.street(placeholder="z.B. Musterstraße", class="input-field") }}
              </div>
            </label>
            <label for="{{ form.state.id }}" class="block text-sm font-semibold text-gray-600">
              <div class="flex justify-between">
                {{ form.state.label.text }}
                {{ popover("popover-bundesland", "Bundesland",
                "Falls der Wert nicht korrekt eingelesen wurde, ergänzen Sie bitte den Namen des Bundeslandes.") }}
              </div>
              <div class="relative">
                {{ form.state(id="state", placeholder="z.B. Berlin", class="input-field") }}
              </div>
            </label>
            <label for="{{ form.district.id }}" class="block text-sm font-semibold text-gray-600">
              <div class="flex justify-between">
                {{ form.district.label.text }}
                {{ popover("popover-bezirk", "Landkreis/Stadt",
                "Falls der Wert nicht korrekt eingelesen wurde, geben Sie bitte den Landkreis/die Stadt ein.") }}
              </div>
              <div class="relative">
                {{ form.district(id="district", placeholder="z.B. Mitte", class="input-field") }}
              </div>
            </label>

	    <label class="block text-sm font-semibold text-gray-600">
	      <div class="flex justify-between">
                {{ form.gender.label.text }}
		<button data-popover-target="popover-gender"
			type="button"
			class="text-black pl-10 pr-2">?</button>
	      </div>
              <div data-popover
		   id="popover-gender"
		   role="tooltip"
		   class="absolute z-50 invisible inline-block w-64 text-sm text-gray-500
			  transition-opacity duration-300 bg-white border border-gray-200 rounded-lg
                          shadow-sm opacity-0 dark:text-gray-400 dark:border-gray-600 dark:bg-gray-800">
                <div
                  class="px-3 py-2 bg-gray-100 border-b border-gray-200 rounded-t-lg dark:border-gray-600 dark:bg-gray-700">
                  <h3 class="font-semibold text-green-900 dark:text-green">
		    Entwicklungsstadium
		  </h3>
                </div>
                <div class="px-3 py-2 bg-green-100">
                  <p>
		    Dieses Feld ist eine kleine Herausforderung für
		    den Melder. Traun Sie sich zu, das Geschlecht
		    oder das Entwicklungsstadium zu bestimmen?
		    Die Merkmale für die Bestimmung sind auf
		    folgender Seite genau beschrieben:
		    
		    <a class="block pb-2 text-sm font-semibold
			      text-blue-600
			      hover:text-blueGray-800"
		       href="/bestimmung"
		       target="_blank">
		      Link: Hilfe zur Bestimmung <br/>(öffnet neuen Tab)</a>
		    
		    In jedem Fall werden sie nach einer Bewertung
		    durch Fackleute über das Ergebnis informiert.
                    <br />
		    Versuchen Sie es!
		    
		  </p>
                </div>
              </div>
	      
              <div class="relative">
                {{ form.gender(class="w-full p-2 mt-1 bg-white border
		rounded-md focus:outline-none focus:ring-1
                focus:ring-green-500") }}
              </div>
            </label>
	  </div>
	  <div>
	    <label class="block text-sm font-semibold text-gray-600">
	      <div class="flex justify-between">
                {{ form.zip_code.label.text }}
		<button data-popover-target="popover-zip"
			type="button"
			class="text-black pl-10 pr-2">?</button>
	      </div>
              <div data-popover
		   id="popover-zip"
		   role="tooltip"
		   class="absolute z-50 invisible inline-block
                          w-64 text-sm text-gray-500 transition-opacity duration-300
			  bg-white border border-gray-200 rounded-lg shadow-sm opacity-0
			  dark:text-gray-400 dark:border-gray-600 dark:bg-gray-800">
			  <div class="px-3 py-2 bg-gray-100 border-b border-gray-200 rounded-t-lg
				      dark:border-gray-600 dark:bg-gray-700">
			    <h3 class="font-semibold text-gray-900 dark:text-white">Postleitzahl</h3>
			  </div>
			  <div class="px-3 py-2">
			    <p>
			      Falls der Wert nicht korrekt eingelesen wurde, geben Sie bitte die Postleitzahl ein.
			    </p>
			  </div>
	  </div>		  
          </label>
            <div class="relative">
              {{ form.zip_code(id="zip_code", placeholder="z.B. 10115", class="input-field") }}
            </div>
            <label for="{{ form.city.id }}" class="block text-sm font-semibold text-gray-600">
              <div class="flex justify-between">
                {{ form.city.label.text }}
                {{ popover("popover-city", "Ort",
                "Falls der Wert nicht korrekt eingelesen wurde, geben Sie bitte den Stadtnamen ein.") }}
              </div>
              <div class="relative">
                {{ form.city(id="city", placeholder="z.B. Berlin", class="input-field") }}
              </div>
            </label>
            <label for="{{ form.location_description.id }}" class="block text-sm font-semibold text-gray-600">
              <div class="flex justify-between">
                {{ form.location_description.label.text }}
                {{ popover("popover-fundort", "Ergänzungen Ort",
                "Beschreiben Sie hier bitte den Ort etwas genauer (maximal 500 Zeichen)") }}
              </div>
              <div class="relative">
                {{ form.location_description(placeholder="Geben Sie hier Ihre Ortsbeschreibung ein",
                class="input-field") }}
              </div>
            </label>
            <label for="{{ form.picture_description.id }}" class="block text-sm font-semibold text-gray-600">
              <div class="flex justify-between">
                {{ form.picture_description.label.text }}
                {{ popover("popover-beschreibung", "Ergänzungen zum Fund",
                "Ergänzende Angaben zum Bild (maximal 500 Zeichen)") }}
              </div>
              <div class="relative">
                {{ form.picture_description(placeholder="Geben Sie hier Ihre Bildbeschreibung ein",
                class="input-field") }}
              </div>
            </label>
          </div>
        </div>

        <div class="flex justify-between mt-4 space-x-2">
          <button type="button" id="step2Prev"
            class="w-full px-6 py-2 text-sm font-medium leading-5 text-center text-white transition-colors duration-150 bg-green-500 border border-transparent rounded-lg hover:bg-green-600 focus:outline-none md:w-auto">
            Prev
          </button>
          <button type="button" id="step2Next"
            class="w-full px-6 py-2 text-sm font-medium leading-5 text-center text-white transition-colors duration-150 bg-green-500 border border-transparent rounded-lg hover:bg-green-600 focus:outline-none md:w-auto">
            Next
          </button>
        </div>
      </div>

      <!-- Step 3: Person(en) -->
      <div id="step3" class="hidden step">
        <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
          <div>
            <label for="{{ form.report_first_name.id }}" class="block text-sm font-semibold text-gray-600">
              <div class="flex justify-between">
                {{ form.report_first_name.label.text }}
                {{ popover("popover-reportvorname", "Vorname",
                "Geben Sie bitte Ihren ersten Buchstaben des Vornamens ein. Beispiel: M. für Max") }}
              </div>
              <div class="relative">
                {{ form.report_first_name(placeholder="Erster Buchstabe z.B. M.", class="input-field") }}
              </div>
            </label>
            <label for="{{ form.report_last_name.id }}" class="block text-sm font-semibold text-gray-600">
              <div class="flex justify-between">
                {{ form.report_last_name.label.text }}
                {{ popover("popover-reportnachname", "Nachname",
                "Geben Sie hier bitte Ihren Nachnamen ein.") }}
              </div>
              <div class="relative">
                {{ form.report_last_name(placeholder="z.B. Mustermann", class="input-field") }}
              </div>
            </label>
            <label for="{{ form.sighting_date.id }}" class="block text-sm font-semibold text-gray-600">
              <div class="flex justify-between">
                {{ form.sighting_date.label.text }}
                {{ popover("popover-datum", "Datum",
                "Wählen Sie hier bitte das Funddatum.") }}
              </div>
              <div class="relative">
                {{ form.sighting_date(placeholder="z.B. 2023-05-14", class="input-field") }}
              </div>
            </label>
          </div>
          <div>
            <label for="{{ form.contact.id }}" class="block text-sm font-semibold text-gray-600">
              <div class="flex justify-between">
                {{ form.contact.label.text }}
                {{ popover("popover-kontakt", "Kontaktdaten",
                "Möchten Sie eine Rückmeldung und eine Bestätigung Ihrer Bestimmung erhalten, hinterlassen Sie gerne
                Ihre E-Mail. Ihre Kontaktdaten werden geschützt, nicht weitergegeben oder anderweitig verwendet.") }}
              </div>
              <div class="relative">
                {{ form.contact(placeholder="z.B. max@example.de", class="input-field") }}
              </div>
            </label>
            <label class="block text-sm font-semibold text-gray-600">
              <div class="flex items-center">
                {{ form.identical_finder_melder(class="mr-2") }}
                <span>Finder und Melder sind identisch</span>
              </div>
            </label>
            <div id="additionalFields" class="hidden">
              <label for="{{ form.finder_first_name.id }}" class="block text-sm font-semibold text-gray-600">
                <div class="flex justify-between">
                  {{ form.finder_first_name.label.text }}
                </div>
                <div class="relative">
                  {{ form.finder_first_name(placeholder="Vorname des Finders", class="input-field") }}
                </div>
              </label>
              <label for="{{ form.finder_last_name.id }}" class="block text-sm font-semibold text-gray-600">
                <div class="flex justify-between">
                  {{ form.finder_last_name.label.text }}
                </div>
                <div class="relative">
                  {{ form.finder_last_name(placeholder="Nachname des Finders", class="input-field") }}
                </div>
              </label>
            </div>
          </div>
        </div>
        <div class="flex justify-between mt-4 space-x-2">
          <button type="button" id="step3Prev"
            class="w-full px-6 py-2 text-sm font-medium leading-5 text-center text-white transition-colors duration-150 bg-green-500 border border-transparent rounded-lg hover:bg-green-600 focus:outline-none md:w-auto">
            Prev
          </button>
          <button type="button" id="step3Next"
            class="w-full px-6 py-2 text-sm font-medium leading-5 text-center text-white transition-colors duration-150 bg-green-500 border border-transparent rounded-lg hover:bg-green-600 focus:outline-none md:w-auto">
            Next
          </button>
        </div>
      </div>

      <div id="step4" class="hidden p-5 rounded-lg shadow-lg step bg-gradient-to-r from-gray-100 to-gray-200">
        <h2 class="mb-4 text-3xl font-semibold text-gray-800">Zusammenfassung</h2>
        <div class="grid grid-cols-1 gap-6 md:grid-cols-2">
          <div class="p-5 bg-white rounded-lg shadow-md">
            <h3 class="mb-2 text-xl font-semibold text-gray-800">Bild</h3>
            <div>
              <img id="summaryImage" class="object-cover w-full h-auto rounded-lg" src="#" alt="Bildvorschau">
            </div>
          </div>
          <div class="p-5 bg-white rounded-lg shadow-md">
            <h3 class="mb-2 text-xl font-semibold text-gray-800">Standort</h3>
            <div id="summaryMap" class="h-64 rounded-lg"></div>
            <ul class="mt-3 text-lg list-disc list-inside">
              <li><strong class="text-gray-800">Längengrad:</strong> <span id="summaryLongitude"></span></li>
              <li><strong class="text-gray-800">Breitengrad:</strong> <span id="summaryLatitude"></span></li>
              <li><strong class="text-gray-800">Straße:</strong> <span id="summaryStreet"></span></li>
              <li><strong class="text-gray-800">Postleitzahl:</strong> <span id="summaryZipCode"></span></li>
              <li><strong class="text-gray-800">Ort:</strong> <span id="summaryCity"></span></li>
              <li><strong class="text-gray-800">Landkreis/Stadt:</strong> <span id="summaryDistrict"></span></li>
              <li><strong class="text-gray-800">Bundesland:</strong> <span id="summaryState"></span></li>
            </ul>
          </div>
        </div>
        <h3 class="mt-8 text-lg font-semibold text-gray-800">Beschreibung</h3>
        <ul class="text-lg list-disc list-inside">
          <li><strong class="text-gray-800">Entwicklungsstadium:</strong> <span id="summaryGender"></span></li>
          <li><strong class="text-gray-800">Ergänzungen Ort:</strong> <span id="summaryLocationDescription"></span>
          </li>
          <li><strong class="text-gray-800">Ergänzungen zum Fund:</strong> <span id="summaryPictureDescription"></span>
          </li>
        </ul>
        <h3 class="mt-8 text-lg font-semibold text-gray-800">Person(en)</h3>
        <ul class="text-lg list-disc list-inside">
          <li><strong class="text-gray-800">Vorname:</strong> <span id="summaryFirstName"></span></li>
          <li><strong class="text-gray-800">Nachname:</strong> <span id="summaryLastName"></span></li>
          <li><strong class="text-gray-800">Datum:</strong> <span id="summarySightingDate"></span></li>
          <li><strong class="text-gray-800">Kontakt:</strong> <span id="summaryContact"></span></li>
        </ul>
        <div class="flex justify-between mt-6 space-x-4">
          <button type="button" id="step4Prev"
            class="w-full px-6 py-2 text-sm font-medium leading-5 text-center text-white transition-colors duration-150 bg-green-500 border border-transparent rounded-lg hover:bg-green-600 focus:outline-none md:w-auto">
            Prev
          </button>
          <form>
            {{ form.submit(class="w-full px-6 py-2 text-sm font-medium leading-5 text-center text-white transition-colors duration-150 bg-green-500 border border-transparent rounded-lg hover:bg-green-600 focus:outline-none md:w-auto") }}
          </form>
        </div>
      </div>
  </div>




  <script>
    let map;
    // Add Leaflet map configuration and event handling
    function initMap() {
      map = L.map('map').setView([52.5200, 13.4050], 5);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        maxZoom: 18,
      }).addTo(map);

      let userMarker;

      // Update form fields on map click
      map.on('click', function (e) {
        document.querySelector('#latitude').value = e.latlng.lat.toFixed(5);
        document.querySelector('#longitude').value = e.latlng.lng.toFixed(5);

        getAddressFromCoordinates(e.latlng.lat, e.latlng.lng);

        if (userMarker) {
          userMarker.remove();
        }

        userMarker = L.marker([e.latlng.lat, e.latlng.lng]).addTo(map);

        // Save form data to local storage
        let formData = {};
        document.querySelectorAll('input, select, textarea').forEach(function (input) {
          formData[input.id] = input.value;
        });
        localStorage.setItem('formData', JSON.stringify(formData));
        updateSummary();  // Also update the summary map right away

        // add longitute and latitude to local storage
        localStorage.setItem('latitude', e.latlng.lat.toFixed(5));
        localStorage.setItem('longitude', e.latlng.lng.toFixed(5));
      });

    }
    document.addEventListener('DOMContentLoaded', initMap);

    function getAddressFromCoordinates(latitude, longitude) {
      const nominatimUrl = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&zoom=18&addressdetails=1`;

      fetch(nominatimUrl)
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          const address = data.address;

          document.querySelector("#zip_code").value = address.postcode ? address.postcode.split(";")[0] : "";
          document.querySelector("#city").value = address.city || address.town || address.village || "";
          document.querySelector("#street").value = `${address.road || ""} ${address.house_number || ""}`.trim();
          document.querySelector("#state").value = address.state || address.city || "";
          document.querySelector("#district").value = address.county || address.suburb || address.borough || "";

          console.log("Returned data:", data);
        })
        .catch(error => {
          console.error("Error fetching address data:", error);
        });
    }

    // Use Jinja2 to pass the Python variables to JavaScript
    let existing_user = {{ existing_user | tojson | safe }};

    // Check if the existing_user is not null
    if (existing_user) {
      // Prefill and lock the fields
      document.getElementById("report_first_name").value = existing_user.user_name.split(" ")[1];
      document.getElementById("report_last_name").value = existing_user.user_name.split(" ")[0];
      document.getElementById("contact").value = existing_user.user_kontakt;

      // Make the fields readonly
      document.getElementById("report_first_name").readOnly = true;
      document.getElementById("report_last_name").readOnly = true;
      document.getElementById("contact").readOnly = true;
    }


    function saveFormDataToLocalStorage() {
      const form = document.getElementById('mainForm');
      const formData = new FormData(form);

      for (const [key, value] of formData.entries()) {
        if (key !== "csrf_token") { // exclude csrf_token
          localStorage.setItem(key, value);
        }
      }
    }

    function loadFormDataFromLocalStorage() {
      const form = document.getElementById('mainForm');

      for (const input of form.elements) {
        if (input.name && input.type !== 'file') {
          const value = localStorage.getItem(input.name);
          if (value) {
            try {
              input.value = value;
            } catch (e) {
              console.error('Error setting input value:', e);
            }
          }
        }
      }
    }


    // Call this function when the page loads to load saved form data.
    document.addEventListener('DOMContentLoaded', loadFormDataFromLocalStorage);

    // Call this function to save form data to local storage when any input changes.
    document.getElementById('mainForm').addEventListener('input', saveFormDataToLocalStorage);

    document.addEventListener('DOMContentLoaded', function () {
      const pictureInput = document.querySelector('#picture');

      pictureInput.addEventListener('change', function (event) {
        const file = event.target.files[0];
        if (!file) return;

        EXIF.getData(file, function () {
          // Read metadata from the image
          const lat = EXIF.getTag(this, 'GPSLatitude');
          const lng = EXIF.getTag(this, 'GPSLongitude');
          const latRef = EXIF.getTag(this, 'GPSLatitudeRef');
          const lngRef = EXIF.getTag(this, 'GPSLongitudeRef');

          if (lat && lng && latRef && lngRef) {
            // Convert coordinates to decimal
            const latitude = toDecimal(lat, latRef);
            const longitude = toDecimal(lng, lngRef);

            // Set the values to the form fields
            document.querySelector('#latitude').value = latitude;
            document.querySelector('#longitude').value = longitude;
            console.log('Latitude: ' + latitude + ' Longitude: ' + longitude);

            getAddressFromCoordinates(latitude, longitude);
          } else {
            // Handle the case when GPS data is not available in the image
            console.log('No GPS data found in the file');
          }
        });
      });
    });


    const input = document.getElementById('{{ form.picture.id }}');
    const preview = document.getElementById('previewImage');
    const previewContainer = document.getElementById('imagePreview');
    const uploadText = document.getElementById('uploadText');

    input.addEventListener('change', function (e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();

        reader.addEventListener('load', function () {
          preview.setAttribute('src', reader.result);
        });

        reader.readAsDataURL(file);
        previewContainer.classList.remove('hidden');
        uploadText.classList.add('hidden');
      } else {
        preview.setAttribute('src', '#');
        previewContainer.classList.add('hidden');
        uploadText.classList.remove('hidden');
      }
    });


    // Check if a success message is being flashed
    {% with messages = get_flashed_messages() %}
    {% if messages %}
    // If there is a success message, clear local storage
    localStorage.clear();
    {% endif %}
    {% endwith %}

    function toDecimal(coord, ref) {
      const [degrees, minutes, seconds] = coord;
      let decimal = degrees + minutes / 60 + seconds / (60 * 60);

      if (ref === 'S' || ref === 'W') {
        decimal = -decimal;
      }

      return decimal;
    }

    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const step3 = document.getElementById('step3');
    const step4 = document.getElementById('step4');
    const step1Next = document.getElementById('step1Next');
    const step2Prev = document.getElementById('step2Prev');
    const step2Next = document.getElementById('step2Next');
    const step3Prev = document.getElementById('step3Prev');
    const step3Next = document.getElementById('step3Next');
    const step4Prev = document.getElementById('step4Prev');
    const additionalFields = document.getElementById('additionalFields');
    const form = document.getElementById('mainForm');

    step1Next.addEventListener('click', () => showStep(1));
    step2Prev.addEventListener('click', () => showStep(0));
    step2Next.addEventListener('click', () => showStep(2));
    step3Prev.addEventListener('click', () => showStep(1));
    step3Next.addEventListener('click', () => showStep(3));
    step4Prev.addEventListener('click', () => showStep(2));

    function showStep(index) {
      step1.classList.toggle('hidden', index !== 0);
      step2.classList.toggle('hidden', index !== 1);
      step3.classList.toggle('hidden', index !== 2);
      step4.classList.toggle('hidden', index !== 3);

      // Call invalidateSize after the step containing the map becomes visible
      if (index === 3) {  // If this is the step number of the summary step
        setTimeout(() => {
          summaryMap.invalidateSize();
        }, 400);  // This delay is to ensure that the DOM has finished updating before invalidateSize is called
      }

      if (index === 2) {
        additionalFields.classList.toggle('hidden', !form.identical_finder_melder.checked);
      }
    }


    form.identical_finder_melder.addEventListener('change', () => {
      additionalFields.classList.toggle('hidden', !form.identical_finder_melder.checked);
    });

    function autoCompleteData(inputField, zipCode, city, district, state) {
      var inputs = ['zip_code', 'city', 'district', 'state'];

      for (const id of inputs) {
        if (inputField.id === id) continue;
        let fieldValue = null;

        switch (id) {
          case 'zip_code':
            fieldValue = zipCode;
            break;
          case 'city':
            fieldValue = city;
            break;
          case 'district':
            fieldValue = district;
            break;
          case 'state':
            fieldValue = state;
            break;
        }

        document.getElementById(id).value = fieldValue || '';
      }
    }

    function getAutoCompleteData(inputField) {
      var query = inputField.value;
      if (query) {
        fetch('/autocomplete?q=' + query)
          .then(response => response.json())
          .then(data => {
            if (data.length > 0) {
              var firstResult = data[0];
              autoCompleteData(inputField, firstResult.plz, firstResult.ort, firstResult.landkreis, firstResult.bundesland);
            }
          });
      }
    }

    document.addEventListener('DOMContentLoaded', function () {
      var zipCodeInput = document.getElementById('zip_code');

      function addEvents(inputField) {
        inputField.addEventListener('keydown', function (event) {
          if (event.key === 'Enter' || event.key === 'Tab') {
            if (inputField.value.length >= 4) {
              getAutoCompleteData(inputField);
            }
          }
        });
        inputField.addEventListener('blur', function () {
          if (inputField.value.length >= 5) {
            getAutoCompleteData(inputField);
          }
        });
        //if input field is empty, clear all other fields related to it
        inputField.addEventListener('input', function () {
          if (inputField.value === '') {
            autoCompleteData(inputField, '', '', '', '');
          }
        });
      }

      addEvents(zipCodeInput);
    });

    // Step 4: Zusammenfassung und Vorschau
    // Map initialization
    const summaryMap = L.map("summaryMap").setView([0, 0], 13);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors',
      maxZoom: 18,
    }).addTo(summaryMap);

    const summaryMarker = L.marker([0, 0]).addTo(summaryMap);
    const summaryMarkerPopup = L.popup().setContent("");
    summaryMarker.bindPopup(summaryMarkerPopup);

    const updateSummary = () => {
      const data = JSON.parse(localStorage.getItem('formData'));

      if (data) {
        // Update the location on the map
        newLatLng = new L.LatLng(data.latitude, data.longitude);
        summaryMarker.setLatLng(newLatLng);
        summaryMap.setView(newLatLng, 13);

        // Add a delay before calling invalidateSize
        setTimeout(() => {
          summaryMap.invalidateSize();
        }, 400);  // Adjust delay as needed

        // Update the popup content
        const popupContent = `<strong>Straße:</strong> ${data.street}<br>
    <strong>Postleitzahl:</strong> ${data.zip_code}<br>
    <strong>Ort:</strong> ${data.city}<br>
    <strong>Landkreis/Stadt:</strong> ${data.district}<br>
    <strong>Bundesland:</strong> ${data.state}`;
        summaryMarkerPopup.setContent(popupContent);

        // Picture is loaded directly from input as per your request, not from localStorage
        const pictureInput = document.getElementById('picture');
        const file = pictureInput.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function () {
            summaryImage.src = reader.result;
          };
          reader.readAsDataURL(file);
        } else {
          summaryImage.src = '#';
        }

        summaryLongitude.textContent = data.longitude;
        summaryLatitude.textContent = data.latitude;
        summaryStreet.textContent = data.street;
        summaryZipCode.textContent = data.zip_code;
        summaryCity.textContent = data.city;
        summaryDistrict.textContent = data.district;
        summaryState.textContent = data.state;
        summaryGender.textContent = data.gender;
        summaryLocationDescription.textContent = data.location_description;
        summaryPictureDescription.textContent = data.picture_description;
        summaryFirstName.textContent = data.report_first_name;
        summaryLastName.textContent = data.report_last_name;
        summarySightingDate.textContent = data.sighting_date;
        summaryContact.textContent = data.contact;
      }
    }

    // Call the updateSummary function whenever the form inputs change
    document.querySelectorAll('input, select, textarea').forEach(function (input) {
      input.addEventListener('input', function () {
        // Store form data in local storage on input change
        let formData = {};
        document.querySelectorAll('input, select, textarea').forEach(function (input) {
          formData[input.id] = input.value;
        });
        localStorage.setItem('formData', JSON.stringify(formData));
        updateSummary();
      });
    });

    // Initially update the summary
    document.addEventListener('DOMContentLoaded', updateSummary);

    function copyToClipboard(id) {
      if (id) {
        var tempInput = document.createElement("input");
        tempInput.value = id;
        document.body.appendChild(tempInput);
        tempInput.select();
        document.execCommand("copy");
        document.body.removeChild(tempInput);
        // Show a success toast or something
      }
      else {
        console.error("No ID provided: " + id);
      }
    }
  </script>
</div>
</div>
</body>

{% endblock content %}
