{% extends "layout.html" %} {% block title %}Database Admin{% endblock %} {%
block content %}
<script
  src="{{ url_for('static', filename='js/flow/flowbite.min.js')}}"
  defer
></script>
<script
  src="{{ url_for('static', filename='js/flow/datepicker.min.js')}}"
  defer
></script>

<div class="container px-4 py-8 mx-auto">
  <h1 class="mb-6 text-3xl font-bold text-gray-800">Database Administration</h1>

  <div
    class="flex flex-wrap items-center justify-between mb-5 md:space-x-6 lg:space-x-8 xl:space-x-4"
  >
    <div
      class="flex flex-wrap items-center w-full space-x-4 md:space-x-4 md:w-auto"
    >
      <!-- Table Select Dropdown -->
      <div class="w-full md:w-auto">
        <select
          id="tableSelect"
          name="table"
          class="w-full px-4 py-2 text-sm font-medium text-gray-900 bg-white border border-gray-200 rounded-lg md:w-auto focus:outline-none hover:bg-gray-100 hover:text-primary-700 focus:z-10 focus:ring-4 focus:ring-gray-200"
        >
          <option value="">Select a table</option>
          {% for table in tables %}
          <option value="{{ table }}">{{ table }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Filter button -->
      <button
        id="filterDropdownButton"
        data-dropdown-toggle="filterDropdown"
        class="flex items-center justify-center w-full px-4 py-2 text-sm font-medium text-gray-900 bg-white border border-gray-200 rounded-lg md:w-auto focus:outline-none hover:bg-gray-100 hover:text-primary-700 focus:z-10 focus:ring-4 focus:ring-gray-200"
        type="button"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          aria-hidden="true"
          class="w-4 h-4 mr-2 text-gray-400"
          viewbox="0 0 20 20"
          fill="currentColor"
        >
          <path
            fill-rule="evenodd"
            d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-5.586L3.293 6.707A1 1 0 013 6V3z"
            clip-rule="evenodd"
          />
        </svg>
        Filter Options
        <svg
          class="-mr-1 ml-1.5 w-5 h-5"
          fill="currentColor"
          viewbox="0 0 20 20"
          xmlns="http://www.w3.org/2000/svg"
          aria-hidden="true"
        >
          <path
            clip-rule="evenodd"
            fill-rule="evenodd"
            d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
          />
        </svg>
      </button>

      <div
        id="filterDropdown"
        class="z-10 hidden w-64 p-4 space-y-3 bg-white divide-y divide-gray-100 rounded-lg shadow-lg sm:w-80"
      >
        <p class="text-sm text-gray-700">
          This is a demo filter dropdown. You can add your custom filter options
          here.
        </p>
        <button
          type="button"
          class="w-full px-4 py-2 mt-3 text-white bg-green-500 rounded-md shadow-sm hover:bg-green-600 focus:ring-2 focus:ring-green-500 focus:ring-offset-2 focus:border-transparent"
        >
          Apply Demo Filter
        </button>
      </div>
    </div>

    <div
      class="relative flex items-center flex-grow w-full mb-2 rounded-lg shadow-sm md:w-auto md:mb-0"
    >
      <form
        id="searchForm"
        class="flex items-center w-full transition-all duration-300 bg-white rounded-lg focus-within:ring-2 focus-within:ring-green-500"
      >
        <!-- Search Bar -->
        <div class="relative flex-grow">
          <button
            type="submit"
            class="absolute inset-y-0 left-0 flex items-center pl-3"
          >
            <svg
              class="w-5 h-5 text-gray-500"
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 20 20"
              fill="currentColor"
              aria-hidden="true"
            >
              <path
                fill-rule="evenodd"
                d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z"
                clip-rule="evenodd"
              />
            </svg>
          </button>
          <input
            type="text"
            id="searchInput"
            name="search"
            placeholder="Search..."
            class="w-full h-full py-2 pl-10 pr-4 transition-shadow duration-300 bg-transparent rounded-l-lg search focus:ring-0 focus:border-transparent"
          />
          <button
            type="button"
            onclick="clearSearch()"
            title="Clear"
            class="absolute p-1 transform -translate-y-1/2 bg-white rounded-full right-5 top-1/2 hover:bg-gray-200 focus:outline-none"
          >
            <svg
              focusable="false"
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              width="16"
              height="16"
            >
              <path
                d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"
              ></path>
            </svg>
          </button>
        </div>
      </form>
    </div>

    <div class="flex items-center w-full space-x-4 md:w-auto">
      <!-- Sortieren Button -->
      <button
        id="dropdownSortButton"
        data-dropdown-toggle="sortDropdown"
        class="flex items-center justify-center flex-grow px-4 py-2 text-sm font-medium text-gray-900 bg-white border border-gray-200 rounded-lg focus:outline-none hover:bg-gray-100 hover:text-primary-700 focus:z-10 focus:ring-4 focus:ring-gray-200"
      >
        <span id="sortText">Sort...</span>
        <svg
          class="-mr-1 ml-1.5 w-5 h-5"
          fill="currentColor"
          viewbox="0 0 20 20"
          xmlns="http://www.w3.org/2000/svg"
          aria-hidden="true"
        >
          <path
            clip-rule="evenodd"
            fill-rule="evenodd"
            d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
          />
        </svg>
      </button>

      <!-- Custom Dropdown Menu -->
      <div
        id="sortDropdown"
        class="z-10 hidden w-48 bg-white divide-y divide-gray-100 rounded-lg shadow"
      >
        <ul
          class="py-2 text-sm text-gray-700"
          aria-labelledby="dropdownSortButton"
        >
          <li
            id="id_asc"
            class="flex items-center px-4 py-2 hover:bg-gray-100"
            onclick="setSortOrder('id_asc')"
          >
            <div class="w-2 h-2 mr-2 bg-green-500 rounded-full"></div>
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="16"
              height="16"
              fill="currentColor"
              class="mr-2 bi bi-sort-numeric-up"
              viewBox="0 0 16 16"
            >
              <path
                d="M12.438 1.668V7H11.39V2.684h-.051l-1.211.859v-.969l1.262-.906h1.046z"
              />
              <path
                fill-rule="evenodd"
                d="M11.36 14.098c-1.137 0-1.708-.657-1.762-1.278h1.004c.058.223.343.45.773.45.824 0 1.164-.829 1.133-1.856h-.059c-.148.39-.57.742-1.261.742-.91 0-1.72-.613-1.72-1.758 0-1.148.848-1.835 1.973-1.835 1.09 0 2.063.636 2.063 2.687 0 1.867-.723 2.848-2.145 2.848zm.062-2.735c.504 0 .933-.336.933-.972 0-.633-.398-1.008-.94-1.008-.52 0-.927.375-.927 1 0 .64.418.98.934.98z"
              />
              <path
                d="M4.5 13.5a.5.5 0 0 1-1 0V3.707L2.354 4.854a.5.5 0 1 1-.708-.708l2-1.999.007-.007a.498.498 0 0 1 .7.006l2 2a.5.5 0 1 1-.707.708L4.5 3.707V13.5z"
              />
            </svg>
            Ascending
          </li>
          <li
            id="id_desc"
            class="flex items-center px-4 py-2 hover:bg-gray-100"
            onclick="setSortOrder('id_desc')"
          >
            <div class="w-2 h-2 mr-2 bg-green-500 rounded-full"></div>
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="16"
              height="16"
              fill="currentColor"
              class="mr-2 bi bi-sort-numeric-down"
              viewBox="0 0 16 16"
            >
              <path
                d="M12.438 14.668V9.334h-.051l-1.211-.859v.969l1.262.906h1.046z"
              />
              <path
                fill-rule="evenodd"
                d="M11.36 1.098c-1.137 0-1.708.657-1.762 1.278h1.004c.058-.223.343-.45.773-.45.824 0 1.164.829 1.133 1.856h-.059c.148-.39.57-.742 1.261-.742.91 0 1.72.613 1.72 1.758 0 1.148-.848 1.835-1.973 1.835-1.09 0-2.063-.636-2.063-2.687 0-1.867.723-2.848 2.145-2.848zm.062 2.735c-.504 0-.933.336-.933.972 0 .633.398 1.008.94 1.008.52 0 .927-.375.927-1 0-.64-.418-.98-.934-.98z"
              />
              <path
                d="M4.5 2.5a.5.5 0 0 1 1 0V12.293l1.146-1.147a.5.5 0 1 1 .708.708l-2 2a.5.5 0 0 1-.708 0l-2-2a.5.5 0 0 1 .708-.708L4.5 12.293V2.5z"
              />
            </svg>
            Descending
          </li>
        </ul>
      </div>
    </div>

    <div class="flex items-center w-full space-x-4 md:w-auto">
      <!-- Dropdown button -->
      <button
        id="dropdownExportButton"
        data-dropdown-toggle="filterForm"
        class="flex items-center justify-center flex-grow px-4 py-2 text-sm font-medium text-gray-100 bg-green-600 border border-green-400 rounded-lg focus:outline-none hover:bg-green-600 hover:text-primary-700 focus:z-10 focus:ring-4 focus:ring-gray-200"
      >
        <svg
          class="w-4 h-4 mr-2"
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewbox="0 0 24 24"
          stroke-width="2"
          stroke="currentColor"
          aria-hidden="true"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5"
          />
        </svg>
        Export
      </button>

      <!-- Dropdown menu -->
      <div
        id="filterForm"
        class="z-10 hidden bg-white divide-y divide-gray-100 rounded-lg shadow w-44"
      >
        <ul
          class="py-2 text-sm text-gray-700"
          aria-labelledby="dropdownExportButton"
        >
          <li>
            <button
              onclick="exportCsv()"
              class="block w-full px-4 py-2 text-left hover:bg-gray-100"
            >
              Export CSV
            </button>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <div id="tableContainer" class="hidden">
    <h2 id="tableTitle" class="mb-4 text-2xl font-semibold text-gray-700"></h2>

    <div class="overflow-x-auto shadow-md sm:rounded-lg">
      <table id="dataTable" class="w-full text-sm text-left text-gray-500">
        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
          <tr id="tableHeader"></tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>

    <!-- Pagination controls -->
    <div class="flex items-center justify-between mt-4">
      <button
        id="prevPage"
        class="px-4 py-2 text-gray-800 bg-gray-200 rounded-md"
      >
        Previous
      </button>
      <span id="pageInfo"></span>
      <button
        id="nextPage"
        class="px-4 py-2 text-gray-800 bg-gray-200 rounded-md"
      >
        Next
      </button>
    </div>
  </div>
</div>

<script>
  let currentTable = "";
  let columnTypes = {};
  let nonEditableFields = [];
  let currentPage = 1;
  let itemsPerPage = 20;
  let totalItems = 0;
  let searchTerm = "";
  let sortOrder = "id_asc";
  let debounceTimer;
  let currentlyEditing = null;

  document
    .getElementById("tableSelect")
    .addEventListener("change", function () {
      currentTable = this.value;
      resetFilters();
      fetchTableData();
    });

  document.getElementById("searchInput").addEventListener("input", function () {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => {
      searchTerm = this.value;
      currentPage = 1;
      fetchTableData();
    }, 300);
  });

  document.getElementById("prevPage").addEventListener("click", function () {
    if (currentPage > 1) {
      currentPage--;
      fetchTableData();
    }
  });

  document.getElementById("nextPage").addEventListener("click", function () {
    if (currentPage < Math.ceil(totalItems / itemsPerPage)) {
      currentPage++;
      fetchTableData();
    }
  });

  document
    .getElementById("filterForm")
    .addEventListener("submit", function (e) {
      e.preventDefault();
      currentPage = 1;
      fetchTableData();
    });

  function setSortOrder(order) {
    sortOrder = order;
    fetchTableData();
    document.getElementById("sortText").textContent =
      order === "id_asc" ? "ID Ascending" : "ID Descending";
  }

  function resetFilters() {
    currentPage = 1;
    searchTerm = "";
    sortOrder = "id_asc";
    document.getElementById("searchInput").value = "";
    document.getElementById("sortText").textContent = "Sort...";
  }

  function fetchTableData() {
    if (!currentTable) {
      document.getElementById("tableContainer").classList.add("hidden");
      return;
    }

    const url = new URL(
      `/admin/get_table_data/${currentTable}`,
      window.location.origin
    );
    url.searchParams.append("page", currentPage);
    url.searchParams.append("per_page", itemsPerPage);
    url.searchParams.append("search", searchTerm);
    url.searchParams.append("sort_order", sortOrder);

    fetch(url)
      .then((response) => response.json())
      .then((data) => {
        if (data.error) {
          alert(data.error);
          return;
        }
        columnTypes = data.column_types;
        nonEditableFields = data.non_editable_fields;
        totalItems = data.total_items;
        displayTable(data.columns, data.data);
        updatePagination();
      })
      .catch((error) => console.error("Error:", error));
  }

  function displayTable(columns, data) {
    const tableContainer = document.getElementById("tableContainer");
    const tableTitle = document.getElementById("tableTitle");
    const tableHeader = document.getElementById("tableHeader");
    const tableBody = document.getElementById("tableBody");

    tableTitle.textContent = `Table: ${currentTable}`;
    tableHeader.innerHTML = columns
      .map((col) => `<th class="px-6 py-3">${col}</th>`)
      .join("");

    tableBody.innerHTML = data
      .map(
        (row, rowIndex) =>
          `<tr class="bg-white border-b hover:bg-gray-50">${row
            .map(
              (cell, cellIndex) =>
                `<td class="px-6 py-4 ${
                  nonEditableFields.includes(columns[cellIndex])
                    ? ""
                    : "editable hover:bg-gray-100 cursor-pointer"
                }" 
                    data-row="${rowIndex}" 
                    data-column="${columns[cellIndex]}" 
                    data-type="${columnTypes[columns[cellIndex]]}">${cell}</td>`
            )
            .join("")}</tr>`
      )
      .join("");

    tableContainer.classList.remove("hidden");
    addEditListeners();
  }

  function updatePagination() {
    const pageInfo = document.getElementById("pageInfo");
    const totalPages = Math.ceil(totalItems / itemsPerPage);
    pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;

    document.getElementById("prevPage").disabled = currentPage === 1;
    document.getElementById("nextPage").disabled = currentPage === totalPages;
  }

  function addEditListeners() {
    const editableCells = document.querySelectorAll("#dataTable td.editable");

    editableCells.forEach((cell) => {
      cell.addEventListener("click", function (event) {
        if (event.target !== this) return;
        if (this.querySelector("input, select")) return;
        if (currentlyEditing && currentlyEditing !== this) {
          cancelEdit(currentlyEditing);
        }

        startEdit(this);
      });
    });

    document.addEventListener("click", function (event) {
      if (currentlyEditing && !currentlyEditing.contains(event.target)) {
        cancelEdit(currentlyEditing);
      }
    });
  }

  function startEdit(cell) {
    currentlyEditing = cell;
    const currentValue = cell.textContent.trim();
    const row = cell.dataset.row;
    const column = cell.dataset.column;
    const type = cell.dataset.type;

    const input = createInputElement(type, currentValue);
    const controlsDiv = createControlsDiv();

    cell.dataset.originalContent = cell.innerHTML;
    cell.innerHTML = "";
    cell.appendChild(input);
    cell.appendChild(controlsDiv);
    input.focus();

    setupEditControls(input, controlsDiv, cell, currentTable, column, row);
  }

  function createInputElement(type, currentValue) {
    let input;
    if (type.includes("bool")) {
      input = document.createElement("select");
      input.innerHTML = `
        <option value="true" ${
          currentValue === "true" ? "selected" : ""
        }>true</option>
        <option value="false" ${
          currentValue === "false" ? "selected" : ""
        }>false</option>
      `;
    } else if (type.includes("int") || type.includes("float")) {
      input = document.createElement("input");
      input.type = "number";
      input.value = currentValue;
    } else if (type.includes("date")) {
      input = document.createElement("input");
      input.type = "date";
      input.value = currentValue;
    } else {
      input = document.createElement("input");
      input.type = "text";
      input.value = currentValue;
    }
    input.classList.add("w-full", "p-1", "border", "rounded");
    return input;
  }

  function createControlsDiv() {
    const controlsDiv = document.createElement("div");
    controlsDiv.classList.add("flex", "justify-between", "mt-2");

    const acceptButton = document.createElement("button");
    acceptButton.innerHTML = "&#10003;";
    acceptButton.title = "Accept";
    acceptButton.classList.add(
      "bg-green-500",
      "text-white",
      "px-2",
      "py-1",
      "rounded"
    );

    const revertButton = document.createElement("button");
    revertButton.innerHTML = "&#8635;";
    revertButton.title = "Revert";
    revertButton.classList.add(
      "bg-red-500",
      "text-white",
      "px-2",
      "py-1",
      "rounded"
    );

    controlsDiv.appendChild(acceptButton);
    controlsDiv.appendChild(revertButton);

    return controlsDiv;
  }

  function setupEditControls(input, controlsDiv, cell, table, column, row) {
    const acceptButton = controlsDiv.querySelector('button[title="Accept"]');
    const revertButton = controlsDiv.querySelector('button[title="Revert"]');

    acceptButton.addEventListener("click", function () {
      updateCell(table, column, row, input.value, cell);
    });

    revertButton.addEventListener("click", function () {
      cancelEdit(cell);
    });

    input.addEventListener("keydown", function (e) {
      if (e.key === "Enter") {
        acceptButton.click();
      } else if (e.key === "Escape") {
        revertButton.click();
      }
    });
  }

  function updateCell(table, column, row, newValue, cell) {
    const idCell = document.querySelector(
      `#dataTable td[data-row="${row}"][data-column="id"]`
    );
    if (!idCell) {
      console.error("Could not find ID cell");
      cancelEdit(cell);
      return;
    }
    const idValue = idCell.textContent;

    fetch("/admin/update_cell", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        table: table,
        column: column,
        id: idValue,
        value: newValue,
      }),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          cell.textContent = newValue;
          currentlyEditing = null;
        } else {
          alert("Failed to update: " + (data.error || "Unknown error"));
          cancelEdit(cell);
        }
      })
      .catch((error) => {
        console.error("Error:", error);
        alert("An error occurred while updating the cell");
        cancelEdit(cell);
      });
  }

  function cancelEdit(cell) {
    if (cell && cell.dataset.originalContent) {
      cell.innerHTML = cell.dataset.originalContent;
      delete cell.dataset.originalContent;
    }
    currentlyEditing = null;
  }

  function exportCsv() {
    if (!currentTable) {
      alert("Please select a table first");
      return;
    }

    const exportButton = document.getElementById("dropdownExportButton");
    // Add loading animation to the button
    exportButton.innerHTML =
      '<svg class="w-5 h-5 mx-auto text-gray-100 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';

    const exportUrl = `/admin/export/csv/${currentTable}`;

    fetch(exportUrl)
      .then((response) => {
        if (!response.ok) {
          throw new Error("Network response was not ok");
        }
        return response.blob();
      })
      .then((blob) => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.style.display = "none";
        a.href = url;
        a.download = `${currentTable}.csv`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
      })
      .catch((error) => {
        console.error("Error:", error);
        alert("An error occurred while exporting the data.");
      })
      .finally(() => {
        // Reset the button after export attempt
        setTimeout(() => {
          exportButton.innerHTML = `
                    <svg class="w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewbox="0 0 24 24"
                        stroke-width="2" stroke="currentColor" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" />
                    </svg>
                    Export
                `;
        }, 3000);
      });
  }
</script>
{% endblock %}
