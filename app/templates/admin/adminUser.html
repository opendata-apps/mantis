{% extends 'layout.html' %}
{% from "macro.html" import render_users_pagination %}

{% block content %}
<div class="container px-4 mx-auto">
    <div class="flex items-center justify-between py-6">
        <div class="w-1/3">
            <form action="{{ url_for('admin.admin_users') }}" method="GET"
                class="flex items-center w-full transition-all duration-300 rounded-lg focus-within:ring-2 focus-within:ring-green-500">
                <!-- Search Bar -->
                <div class="relative flex-grow">
                    <button type="submit" class="absolute inset-y-0 left-0 flex items-center pl-3">
                        <svg class="w-5 h-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"
                            fill="currentColor" aria-hidden="true">
                            <path fill-rule="evenodd"
                                d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z"
                                clip-rule="evenodd" />
                        </svg>
                    </button>
                    <input type="text" id="searchInput" name="q" placeholder="Suche nach Name, E-Mail, Rolle"
                        value="{{ request.args.get('search', '') }}" maxlength="50"
                        class="w-full h-full py-2 pl-10 pr-4 transition-shadow duration-300 bg-transparent rounded-l-lg search focus:ring-0 focus:border-transparent">
                    <button type="button" onclick="clearSearch()" title="löschen"
                        class="absolute p-1 transform -translate-y-1/2 rounded-full right-5 top-1/2 hover:bg-gray-200 focus:outline-none">
                        <svg focusable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16"
                            height="16">
                            <path
                                d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z">
                            </path>
                        </svg>
                    </button>
                </div>
                <div class="relative">
                    <select id="searchType" name="search_type" onchange="changeInputPattern()"
                        class="block h-full px-4 py-2 leading-tight bg-transparent rounded-r-lg search focus:ring-0 focus:border-transparent">
                        <option value="name" {% if search_type=='name' %}selected{% endif %}>
                            Name</option>
                        <option value="userID" {% if search_type=='userID' %}selected{% endif %}>userID</option>
                        <option value="email" {% if search_type=='email' %}selected{% endif %}>E-Mail</option>
                        <option value="Rolle" {% if search_type=='Rolle' %}selected{% endif %}>Rolle</option>
                    </select>
                </div>
                <button type="submit" class="hidden">Suchen</button>
            </form>
        </div>
        <div class="flex space-x-4">
            <button id="addUserBtn" class="px-4 py-2 font-bold text-white bg-green-500 rounded hover:bg-green-700"><i
                    class=""></i> Add User</button>
            <button id="exportBtn" class="px-4 py-2 font-bold text-white bg-blue-500 rounded hover:bg-blue-700"><i
                    class=""></i> Export</button>
        </div>
    </div>

    <table class="min-w-full leading-normal">
        <thead>
            <tr>
                <th
                    class="px-5 py-3 text-xs font-semibold tracking-wider text-left text-gray-600 uppercase bg-gray-100 border-b-2 border-gray-200">
                    ID</th>
                <th
                    class="px-5 py-3 text-xs font-semibold tracking-wider text-left text-gray-600 uppercase bg-gray-100 border-b-2 border-gray-200">
                    Name</th>
                <th
                    class="px-5 py-3 text-xs font-semibold tracking-wider text-left text-gray-600 uppercase bg-gray-100 border-b-2 border-gray-200">
                    Rolle</th>
                <th
                    class="px-5 py-3 text-xs font-semibold tracking-wider text-left text-gray-600 uppercase bg-gray-100 border-b-2 border-gray-200">
                    Email</th>
                <th
                    class="px-5 py-3 text-xs font-semibold tracking-wider text-left text-gray-600 uppercase bg-gray-100 border-b-2 border-gray-200">
                    UserID</th>
                <th class="px-5 py-3 bg-gray-100 border-b-2 border-gray-200"></th>
            </tr>
        </thead>
        <tbody>
            {% for user in users %}
            <tr class="transition-colors duration-300 ease-in-out hover:bg-green-100" data-userid="{{ user.id }}">
                <td class="px-5 py-5 text-sm border-b border-gray-200">
                    <p class="text-gray-900 whitespace-no-wrap">{{ user.id }}</p>
                </td>
                <td class="px-5 py-5 text-sm border-b border-gray-200">
                    <div contenteditable="false" class="editable" data-id="{{ user.id }}" data-field="user_name">{{ user.user_name }}</div>
                </td>
                <td class="px-5 py-5 text-sm border-b border-gray-200">
                    <div id="role-display-{{ user.id }}" class="editable" data-id="{{ user.id }}" data-field="user_rolle">{{ user.user_rolle }}</div>
                    <select id="role-select-{{ user.id }}" class="hidden">
                        <option value="1" {% if user.user_rolle == '1' %}selected{% endif %}>Melder</option>
                        <option value="2" {% if user.user_rolle == '2' %}selected{% endif %}>Finder</option>
                        <option value="9" {% if user.user_rolle == '9' %}selected{% endif %}>Reviewer</option>
                    </select>
                </td>
                <td class="px-5 py-5 text-sm border-b border-gray-200">
                    <div contenteditable="false" class="editable" data-id="{{ user.id }}" data-field="user_kontakt">{{ user.user_kontakt }}</div>
                </td>
                <td class="px-5 py-5 text-sm border-b border-gray-200">
                    <div contenteditable="false" class="editable" data-id="{{ user.id }}" data-field="user_id">{{ user.user_id }}</div>
                </td>
                <td class="px-5 py-5 text-sm border-b border-gray-200">
                    <button id="edit-button-{{ user.id }}" aria-label="Edit user"
                    class="px-4 py-2 font-bold text-white bg-green-500 rounded-l icon-button hover:bg-green-700"
                    onclick="makeEditable({{ user.id }})">
                    Bearbeiten
                        <svg fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                            <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z">
                            </path>
                            <path fill-rule="evenodd"
                                d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z"
                                clip-rule="evenodd"></path>
                        </svg>
                    </button>
                    <button id="save-button-{{ user.id }}" class="save-button" onclick="saveChanges({{ user.id }})">
                        ✓
                    </button>
                    <button id="cancel-button-{{ user.id }}" class="cancel-button" onclick="cancelChanges({{ user.id }})">
                        X
                    </button>
                    <form action="{{ url_for('admin.delete_user', user_id=user.id) }}" method="post" class="inline">
                        <button aria-label="Delete user"
                            class="px-4 py-2 font-bold text-white bg-red-600 rounded-r icon-button hover:bg-red-800">
                            User Löschen
                            <svg fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                <path fill-rule="evenodd"
                                    d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z"
                                    clip-rule="evenodd"></path>
                            </svg>
                        </button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="py-4">
        {{ render_users_pagination(pagination, 'admin.admin_users', request.args.get('q', ''),
        request.args.get('search_type', '')) }}
    </div>
</div>

<style>
    /* Additional styles if needed */
    .icon-button svg {
        display: inline-block !important;
        width: 1em !important;
        height: 1em !important;
        fill: currentColor !important;
        vertical-align: middle !important;
    }

    .save-button, .cancel-button {
        display: none;
        cursor: pointer;
        padding: 0.5rem;
        margin-left: 0.25rem;
        font-size: 0.875rem;
        line-height: 1.25rem;
        border-radius: 9999px;
    }
    .save-button {
        color: white;
        background-color: #10b981; /* green-500 */
    }
    .cancel-button {
        color: white;
        background-color: #ef4444; /* red-500 */
    }
</style>

<script>
    function clearSearch() {
        document.getElementById('searchInput').value = '';
        document.getElementById('searchInput').form.submit();
    }

    function makeEditable(userId) {
        // Toggle visibility of the display div and the select dropdown
        document.getElementById(`role-display-${userId}`).classList.add('hidden');
        document.getElementById(`role-select-${userId}`).classList.remove('hidden');

        // Make other fields editable
        document.querySelectorAll(`[data-id="${userId}"]`).forEach(function(element) {
            if (element.hasAttribute('contenteditable')) {
                element.setAttribute('contenteditable', 'true');
                element.classList.add('input-field');
            }
        });

        // Add input-field class to the select dropdown
        document.getElementById(`role-select-${userId}`).classList.add('input-field');

        document.querySelector(`tr[data-userid="${userId}"]`).classList.add('bg-green-200');

        document.getElementById(`edit-button-${userId}`).style.display = 'none';
        document.getElementById(`save-button-${userId}`).style.display = 'inline';
        document.getElementById(`cancel-button-${userId}`).style.display = 'inline';
    }

    function saveChanges(userId) {
        // Collect data from editable fields
        let userName = document.querySelector(`[data-id="${userId}"][data-field="user_name"]`).innerText;
        let userEmail = document.querySelector(`[data-id="${userId}"][data-field="user_kontakt"]`).innerText;
        let userIdValue = document.querySelector(`[data-id="${userId}"][data-field="user_id"]`).innerText;
        let userRole = document.getElementById(`role-select-${userId}`).value;

        // AJAX request to update user data
        fetch(`/update_user/${userId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                user_name: userName,
                user_email: userEmail,
                user_id: userIdValue,
                user_role: userRole
            }),
        })
        .then(response => response.json())
        .then(data => {
            if(data.success) {
                // Update UI to reflect saved changes
                document.getElementById(`role-display-${userId}`).innerText = userRole;
                document.getElementById(`role-display-${userId}`).classList.remove('hidden');
                document.getElementById(`role-select-${userId}`).classList.add('hidden');
                document.querySelectorAll(`[data-id="${userId}"]`).forEach(function(element) {
                    element.setAttribute('contenteditable', 'false');
                    element.classList.remove('input-field');
                });
                document.querySelector(`tr[data-userid="${userId}"]`).classList.remove('bg-green-200');
            } else {
                // Optionally, handle errors
            }
            // Hide the save and cancel buttons and show the edit button
            document.getElementById(`edit-button-${userId}`).style.display = 'inline';
            document.getElementById(`save-button-${userId}`).style.display = 'none';
            document.getElementById(`cancel-button-${userId}`).style.display = 'none';
        })
        .catch(error => console.error('Error:', error));
    }


    function cancelChanges(userId) {
        location.reload();
    }
</script>
{% endblock %}