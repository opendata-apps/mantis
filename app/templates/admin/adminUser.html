{% extends 'layout.html' %}
{% from "macro.html" import render_users_pagination %}

{% block content %}
<div class="container px-4 mx-auto">
    <div class="flex items-center justify-between py-6">
        <div class="w-1/3">
            <form action="{{ url_for('admin.admin_users') }}" method="GET"
                class="flex items-center w-full transition-all duration-300 rounded-lg focus-within:ring-2 focus-within:ring-green-500">
                <!-- Search Bar -->
                <div class="relative flex-grow">
                    <button type="submit" class="absolute inset-y-0 left-0 flex items-center pl-3">
                        <svg class="w-5 h-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"
                            fill="currentColor" aria-hidden="true">
                            <path fill-rule="evenodd"
                                d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z"
                                clip-rule="evenodd" />
                        </svg>
                    </button>
                    <input type="text" id="searchInput" name="q" placeholder="Suche nach Name, E-Mail, Rolle"
                        value="{{ request.args.get('search', '') }}" maxlength="50"
                        class="w-full h-full py-2 pl-10 pr-4 transition-shadow duration-300 bg-transparent rounded-l-lg search focus:ring-0 focus:border-transparent">
                    <button type="button" onclick="clearSearch()" title="lÃ¶schen"
                        class="absolute p-1 transform -translate-y-1/2 rounded-full right-5 top-1/2 hover:bg-gray-200 focus:outline-none">
                        <svg focusable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16"
                            height="16">
                            <path
                                d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z">
                            </path>
                        </svg>
                    </button>
                </div>
                <div class="relative">
                    <select id="searchType" name="search_type" onchange="changeInputPattern()"
                        class="block h-full px-4 py-2 leading-tight bg-transparent rounded-r-lg search focus:ring-0 focus:border-transparent">
                        <option value="name" {% if search_type=='name' %}selected{% endif %}>
                            Name</option>
                        <option value="userID" {% if search_type=='userID' %}selected{% endif %}>userID</option>
                        <option value="email" {% if search_type=='email' %}selected{% endif %}>E-Mail</option>
                        <option value="Rolle" {% if search_type=='Rolle' %}selected{% endif %}>Rolle</option>
                    </select>
                </div>
                <button type="submit" class="hidden">Suchen</button>
            </form>
        </div>
        <div class="flex space-x-4">
            <button id="addUserBtn" class="px-4 py-2 font-bold text-white bg-green-500 rounded hover:bg-green-700"><i
                    class=""></i> Add User</button>
            <button id="exportBtn" class="px-4 py-2 font-bold text-white bg-blue-500 rounded hover:bg-blue-700"><i
                    class=""></i> Export</button>
        </div>
    </div>

    <table class="min-w-full leading-normal">
        <thead>
            <tr>
                <th
                    class="px-5 py-3 text-xs font-semibold tracking-wider text-left text-gray-600 uppercase bg-gray-100 border-b-2 border-gray-200">
                    ID</th>
                <th
                    class="px-5 py-3 text-xs font-semibold tracking-wider text-left text-gray-600 uppercase bg-gray-100 border-b-2 border-gray-200">
                    Name</th>
                <th
                    class="px-5 py-3 text-xs font-semibold tracking-wider text-left text-gray-600 uppercase bg-gray-100 border-b-2 border-gray-200">
                    Rolle</th>
                <th
                    class="px-5 py-3 text-xs font-semibold tracking-wider text-left text-gray-600 uppercase bg-gray-100 border-b-2 border-gray-200">
                    Email</th>
                <th
                    class="px-5 py-3 text-xs font-semibold tracking-wider text-left text-gray-600 uppercase bg-gray-100 border-b-2 border-gray-200">
                    UserID</th>
                <th class="px-5 py-3 bg-gray-100 border-b-2 border-gray-200"></th>
            </tr>
        </thead>
        <tbody>
            {% for user in users %}
            <tr class="transition-colors duration-300 ease-in-out hover:bg-green-100" data-userid="{{ user.id }}">
                <td class="px-5 py-5 text-sm border-b border-gray-200">
                    <p class="text-gray-900 whitespace-no-wrap">{{ user.id }}</p>
                </td>
                <td class="px-5 py-5 text-sm border-b border-gray-200">
                    <div contenteditable="false" class="editable" data-id="{{ user.id }}" data-field="user_name">{{
                        user.user_name }}</div>
                </td>
                <td class="px-5 py-5 text-sm border-b border-gray-200">
                    <div id="role-display-{{ user.id }}" class="editable" data-id="{{ user.id }}"
                        data-field="user_rolle">{{ user.user_rolle }}</div>
                    <select id="role-select-{{ user.id }}" class="hidden">
                        <option value="1" {% if user.user_rolle=='1' %}selected{% endif %}>Melder</option>
                        <option value="2" {% if user.user_rolle=='2' %}selected{% endif %}>Finder</option>
                        <option value="9" {% if user.user_rolle=='9' %}selected{% endif %}>Reviewer</option>
                    </select>
                </td>
                <td class="px-5 py-5 text-sm border-b border-gray-200">
                    <div contenteditable="false" class="editable" data-id="{{ user.id }}" data-field="user_kontakt">{{
                        user.user_kontakt }}</div>
                </td>
                <td class="px-5 py-5 text-sm border-b border-gray-200">
                    <div class="relative flex items-center">
                        <div contenteditable="false" class="pr-8 editable" data-id="{{ user.id }}" data-field="user_id">
                            {{ user.user_id }}
                        </div>
                        <button id="regenerateUserId" onclick="regenerateUserId('{{ user.id }}')" class="absolute right-0 mr-4" hidden>                
                            <svg xmlns="http://www.w3.org/2000/svg" enable-background="new 0 0 51.668 57.679" viewBox="0 0 51.668 57.679" class="w-5 h-5">
                                <path fill="#44444d" d="M25.837,57.679c-6.618,0-13.236-2.519-18.274-7.557c-7.724-7.726-9.756-19.541-5.055-29.401c0.438-0.921,1.542-1.314,2.46-0.872c0.921,0.438,1.312,1.54,0.872,2.46c-4.028,8.453-2.287,18.581,4.334,25.202c8.636,8.638,22.69,8.638,31.326,0c8.637-8.636,8.637-22.688,0-31.325c-6.619-6.62-16.747-8.361-25.204-4.333c-0.917,0.438-2.021,0.048-2.461-0.873c-0.438-0.92-0.048-2.022,0.873-2.461c9.861-4.698,21.678-2.666,29.403,5.056c10.075,10.077,10.075,26.472,0,36.548C39.073,55.16,32.455,57.679,25.837,57.679z"></path>
                                <path fill="#44444d" d="M20.141,20.61c-0.186,0-0.374-0.028-0.561-0.088L6.509,16.354c-0.972-0.31-1.508-1.349-1.198-2.319L9.374,1.286c0.31-0.971,1.347-1.508,2.319-1.198c0.972,0.31,1.508,1.348,1.198,2.319L9.389,13.396l11.313,3.608c0.972,0.31,1.508,1.349,1.198,2.319C21.649,20.109,20.923,20.61,20.141,20.61z"></path>
                            </svg>
                        </button>
                    </div>
                </td>
                <td class="px-5 py-5 text-sm border-b border-gray-200">
                    <div class="flex items-center">
                        <div class="edit-button-container">
                            <button id="edit-button-{{ user.id }}" aria-label="Edit user"
                                class="px-4 py-2 font-bold text-green-500 border border-green-500 rounded-md icon-button hover:bg-green-500 hover:text-white"
                                onclick="makeEditable({{ user.id }})">
                                <svg fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                    <path
                                        d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z">
                                    </path>
                                    <path fill-rule="evenodd"
                                        d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z"
                                        clip-rule="evenodd"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="ml-20 dropdown-button-container">
                            <button id="dott-dropdown-button" data-dropdown-toggle="dott-dropdown"
                                class="inline-flex items-center p-0.5 text-sm font-medium text-center text-gray-500 hover:text-gray-800 rounded-lg focus:outline-none"
                                type="button">
                                <svg class="w-5 h-5" aria-hidden="true" fill="currentColor" viewbox="0 0 20 20"
                                    xmlns="http://www.w3.org/2000/svg">
                                    <path
                                        d="M6 10a2 2 0 11-4 0 2 2 0 014 0zM12 10a2 2 0 11-4 0 2 2 0 014 0zM16 12a2 2 0 100-4 2 2 0 000 4z" />
                                </svg>
                            </button>
                        </div>
                        <div id="dott-dropdown"
                            class="z-10 hidden bg-white divide-y divide-gray-100 rounded shadow w-44">
                            <button id="delete-user-button"
                                class="flex items-center block px-4 py-2 text-sm font-bold text-gray-700 hover:bg-gray-100"
                                type="button">
                                <svg class="inline-block w-6 text-red-500" fill="currentColor" viewBox="0 0 20 20"
                                    xmlns="http://www.w3.org/2000/svg">
                                    <path fill-rule="evenodd"
                                        d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z"
                                        clip-rule="evenodd"></path>
                                </svg>
                                <span class="ml-2">Delete User</span>
                            </button>
                        </div>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="py-4">
        {{ render_users_pagination(pagination, 'admin.admin_users', request.args.get('q', ''),
        request.args.get('search_type', '')) }}
    </div>

    
</div>

<style>
    .icon-button svg {
        display: inline-block !important;
        width: 1em !important;
        height: 1em !important;
        fill: currentColor !important;
        vertical-align: middle !important;
        transform: scale(1.5);
    }
</style>

<script>
    function clearSearch() {
        document.getElementById('searchInput').value = '';
        document.getElementById('searchInput').form.submit();
    }

    function makeEditable(userId) {
        // Toggle visibility of the display div and the select dropdown
        document.getElementById(`role-display-${userId}`).classList.add('hidden');
        document.getElementById(`role-select-${userId}`).classList.remove('hidden');

        // Make other fields editable
        document.querySelectorAll(`[data-id="${userId}"]`).forEach(function (element) {
            if (element.hasAttribute('contenteditable')) {
                element.setAttribute('contenteditable', 'true');
                element.classList.add('input-field');
            }
        });

        // find regenerateUserId button and show it
        document.getElementById('regenerateUserId').hidden = false;

        // Add input-field class to the select dropdown
        document.getElementById(`role-select-${userId}`).classList.add('input-field');

        document.querySelector(`tr[data-userid="${userId}"]`).classList.add('bg-green-200');
    }

    function regenerateUserId(user_id) {
        // Show confirmation dialog box
        if (confirm("Warning: This action cannot be undone. Are you sure you want to regenerate the user ID?")) {
            fetch(`/regenerate_user_id`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.message === 'User id regenerated') {
                    document.querySelector(`[data-id="${user_id}"][data-field="user_id"]`).innerText = data.new_id;
                } else {
                    console.error('Error regenerating user ID');
                }
            })
            .catch(error => console.error('Error:', error));
        }
    }
    
    
    


    function saveChanges(userId) {
        // Collect data from editable fields
        let userName = document.querySelector(`[data-id="${userId}"][data-field="user_name"]`).innerText;
        let userEmail = document.querySelector(`[data-id="${userId}"][data-field="user_kontakt"]`).innerText;
        let userIdValue = document.querySelector(`[data-id="${userId}"][data-field="user_id"]`).innerText;
        let userRole = document.getElementById(`role-select-${userId}`).value;

        // AJAX request to update user data
        fetch(`/update_user/${userId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                user_name: userName,
                user_email: userEmail,
                user_id: userIdValue,
                user_role: userRole
            }),
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update UI to reflect saved changes
                    document.getElementById(`role-display-${userId}`).innerText = userRole;
                    document.getElementById(`role-display-${userId}`).classList.remove('hidden');
                    document.getElementById(`role-select-${userId}`).classList.add('hidden');
                    document.querySelectorAll(`[data-id="${userId}"]`).forEach(function (element) {
                        element.setAttribute('contenteditable', 'false');
                        element.classList.remove('input-field');
                    });
                    document.querySelector(`tr[data-userid="${userId}"]`).classList.remove('bg-green-200');
                } else {
                    // Optionally, handle errors
                }
                // Hide the save and cancel buttons and show the edit button
                document.getElementById(`edit-button-${userId}`).style.display = 'inline';
                document.getElementById(`save-button-${userId}`).style.display = 'none';
                document.getElementById(`cancel-button-${userId}`).style.display = 'none';
            })
            .catch(error => console.error('Error:', error));
    }


    function cancelChanges(userId) {
        location.reload();
    }
</script>
{% endblock %}