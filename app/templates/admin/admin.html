{% extends "layout.html" %}
{% from "macro.html" import popover %}

{% block content %}

<div class="container px-4 mx-auto my-10 md:px-12">
    <h1 class="text-4xl font-bold text-center">Admin Dashboard</h1>

    <div class="flex items-center justify-between w-full p-2 mb-6 rounded shadow">
        <!-- Add the switch toggle -->
        <label class="flex items-center space-x-2">
            <input type="checkbox" id="toggleSwitch" onchange="toggleApprovedSightings()" checked>
            <span class="text-sm font-medium">Show only non-approved sightings</span>
        </label>
        <input type="text" id="searchInput" onkeyup="searchReports()" placeholder="Search for reports..."
            class="w-2/3 p-2 rounded shadow outline-none focus:ring-2 focus:ring-blue-500">
        <select id="sortInput" onchange="sortReports()"
            class="w-1/5 p-2 rounded shadow outline-none focus:ring-2 focus:ring-blue-500">
            <option value="">Sort by...</option>
            <option value="id_asc">ID Ascending</option>
            <option value="id_desc">ID Descending</option>
        </select>
        <button onclick="exportCSV()" class="px-4 py-2 ml-2 font-bold text-white bg-blue-500 rounded hover:bg-blue-700">
            Export CSV
        </button>
    </div>


    <div class="flex flex-wrap mt-6" id="reportContainer">
        {% for sighting in reported_sightings %}
        <!-- Your HTML code for each sighting... -->
        <div class="w-full px-2 mb-4 md:w-1/2 lg:w-1/3 report-card" data-report-id="{{sighting.id}}">
            <div class="p-6 bg-white rounded shadow-sm {{ 'bg-green-100' if sighting.approved }}">
                <h2 class="mb-2 text-xl font-bold">Report ID: {{ sighting.id }}</h2>
                <p><strong>Date Reported:</strong> {{ sighting.dat_meld }}</p>
                {% if sighting.dat_bear %}
                <p data-dat-bear="{{ sighting.dat_bear }}"><strong>Date Approved:</strong> {{ sighting.dat_bear }}</p>
                {% endif %}
                <p><strong>Location ID:</strong> {{ sighting.fo_zuordnung }}</p>
                <p><strong>Details:</strong> {{ sighting.anm_melder }}</p>
                <div class="flex items-center mt-4">
                    <button onclick="openModal({{sighting.id}})" class="text-blue-500 hover:text-blue-800">
                        <img src="/static/images/svg/edit.svg" alt="Edit" class="w-5 h-5">
                    </button>
                    <button onclick="deleteSighting({{sighting.id}})" class="ml-4 text-red-500 hover:text-red-800">
                        <img src="/static/images/svg/delete.svg" alt="Delete" class="w-5 h-5">
                    </button>
                    <div class="inline-flex items-center ml-auto">
                        {% set total = sighting.art_m + sighting.art_w + sighting.art_n +
                        sighting.art_o %}
                        <select id="gender-{{sighting.id}}"
                            class="px-3 py-2 mr-2 text-sm font-medium border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
                            onchange="changeGender({{sighting.id}})" {{ 'disabled' if sighting.dat_bear or total> 1 }} >
                            <option value="M" {{ 'selected' if sighting.art_m==1 }}>M채nnlich</option>
                            <option value="W" {{ 'selected' if sighting.art_w==1 }}>Weiblich</option>
                            <option value="N" {{ 'selected' if sighting.art_n==1 }}>Nymphe</option>
                            <option value="O" {{ 'selected' if sighting.art_o==1 }}>Ootheke</option>
                        </select>
                        {% if sighting.dat_bear %}
                        <span
                            class="inline-flex items-center px-4 py-2 text-sm font-medium text-gray-800 bg-green-100 rounded-md">
                            Approved
                        </span>
                        {% else %}
                        <button onclick="toggleApprove({{sighting.id}})"
                            class="inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-green-500 rounded-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                            Approve
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>


<!-- Modal -->
<div id="modal" class="fixed inset-0 z-10 hidden overflow-y-auto bg-gray-500 bg-opacity-75">
    <div class="flex items-center justify-center min-h-screen">
        <div class="bg-white rounded-lg shadow-xl">
            <div class="px-4 py-4">
                <!-- Tab Buttons -->
                <div class="flex justify-center mb-4">
                    <button
                        class="px-4 py-2 font-semibold text-green-700 bg-blue-100 rounded-lg focus:outline-none hover:bg-green-600 hover:text-white active"
                        id="tab-general-info">General Information</button>
                    <button
                        class="px-4 py-2 ml-2 font-semibold text-green-700 bg-blue-100 rounded-lg focus:outline-none hover:bg-green-600 hover:text-white"
                        id="tab-location-info">Place of Sighting with Map</button>
                    <button
                        class="px-4 py-2 ml-2 font-semibold text-green-700 bg-blue-100 rounded-lg focus:outline-none hover:bg-green-600 hover:text-white"
                        id="tab-user-info">User Information</button>
                </div>
                <!-- Tab Content -->
                <div id="tab-content">
                    <!-- Content will be loaded here -->
                </div>
                <!-- Actions -->
                <div class="flex justify-end mt-4">
                    <button type="button"
                        class="px-4 py-2 font-semibold text-green-900 bg-green-500 rounded-lg focus:outline-none hover:bg-green-700 hover:text-white"
                        onclick="saveChanges()">Save Changes</button>
                    <button type="button"
                        class="px-4 py-2 ml-2 font-semibold text-gray-700 bg-gray-200 rounded-lg focus:outline-none hover:bg-gray-400"
                        onclick="closeModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let map;
    let marker;



    document.addEventListener("DOMContentLoaded", function () {
        document.getElementById("sortInput").value = "id_asc";
        sortReports();
    });

    function sortReports() {
        let input = document.getElementById('sortInput').value;
        let cards = Array.from(document.getElementsByClassName('report-card'));

        cards.sort((a, b) => {
            let idA = a.getAttribute('data-report-id');
            let idB = b.getAttribute('data-report-id');

            if (input == 'id_asc') {
                return idA - idB;
            } else if (input == 'id_desc') {
                return idB - idA;
            }
        });

        let container = document.getElementById('reportContainer');

        cards.forEach((card) => {
            container.appendChild(card);
        });
    }

    function changeGender(id) {
        const selectElement = document.getElementById(`gender-${id}`);
        const newGender = selectElement.value;

        fetch(`/change_mantis_gender/${id}`, {
            method: 'POST',
            body: new URLSearchParams({ new_gender: newGender }),
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log(`Changed gender of report ${id} to ${newGender}`);
                } else {
                    console.error('Failed to change gender:', data.error);
                }
            });
    }

    function searchReports() {
        // Get input value
        let input = document.getElementById('searchInput').value.toLowerCase();
        let cards = document.getElementsByClassName('report-card');

        // Hide or show cards based on input
        for (let i = 0; i < cards.length; i++) {
            let id = cards[i].getAttribute('data-report-id');
            if (id.toLowerCase().includes(input)) {
                cards[i].style.display = "";
            } else {
                cards[i].style.display = "none";
            }
        }
    }

    // Function to toggle approve a sighting
    function toggleApprove(id) {
        fetch('/toggle_approve_sighting/' + id, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log(`Changed approval status of report ${id}`);
                    // Remove the approved card from the view
                    removeCardFromView(id);
                } else {
                    console.error('Failed to change approval status:', data.error);
                }
            })
            .catch(error => console.error('Error:', error));
    }

    function fetchReport(id) {
        fetch('/get_sighting/' + id)
            .then(response => response.json())
            .then(data => {
                openModal(data);
            })
            .catch(error => console.error('Error:', error));
    }

    function openModal(id) {
        // Get report details and show in modal
        fetch('/get_sighting/' + id)
            .then(response => response.json())
            .then(data => {
                // Get tab buttons and content container
                let tabGeneralInfo = document.getElementById('tab-general-info');
                let tabLocationInfo = document.getElementById('tab-location-info');
                let tabUserInfo = document.getElementById('tab-user-info');
                let tabContent = document.getElementById('tab-content');

                console.log(data.latitude, data.longitude);
                // Set initial content
                tabContent.innerHTML = generateGeneralInfo(data);
                setActiveTab(tabGeneralInfo);

                // Add click listeners to tab buttons
                tabGeneralInfo.addEventListener('click', function () {
                    if (!this.classList.contains('active')) {
                        tabContent.innerHTML = generateGeneralInfo(data);
                        setActiveTab(this);
                    }
                });


                locationData = data;
                console.log(locationData.latitude, locationData.longitude);

                tabLocationInfo.addEventListener('click', function () {
                    if (!this.classList.contains('active')) {
                        tabContent.innerHTML = generateLocationInfo(locationData);
                        setActiveTab(this);

                        // Initiate the map when 'Place of Sighting with Map' tab is clicked
                        setTimeout(function () {
                            let lat = parseFloat(locationData.latitude.replace(',', '.'));
                            let lng = parseFloat(locationData.longitude.replace(',', '.'));
                            map = L.map('map').setView([lat, lng], 13);


                            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                                maxZoom: 18,
                                tileSize: 512,
                                zoomOffset: -1
                            }).addTo(map);

                            L.marker([lat, lng]).addTo(map);
                            console.log('Lat:', lat, 'Lng:', lng);

                            // Redraw tiles after the modal is shown
                            map.invalidateSize();
                        }, 0);
                    }
                });


                tabUserInfo.addEventListener('click', function () {
                    if (!this.classList.contains('active')) {
                        tabContent.innerHTML = generateUserInfo(data);
                        setActiveTab(this);
                    }
                });

                // Show the modal
                document.getElementById('modal').classList.remove('hidden');
            })
            .catch(error => console.error('Error:', error));
    }


    function setActiveTab(tab) {
        // Remove 'active' class from all tabs
        let tabs = [document.getElementById('tab-general-info'), document.getElementById('tab-location-info'), document.getElementById('tab-user-info')];
        tabs.forEach(t => t.classList.remove('active'));
        // Add 'active' class to the selected tab
        tab.classList.add('active');
    }


    function generateGeneralInfo(data) {
        // Determine gender based on the art_ fields
        let gender = '';
        if (data.art_m) {
            gender = 'M채nnlich';
        } else if (data.art_w) {
            gender = 'Weiblich';
        } else if (data.art_n) {
            gender = 'Nymphe';
        } else if (data.art_o) {
            gender = 'Ootheke';
        }

        // Convert general info into HTML string
        return `<p><strong>Report ID:</strong> ${data.id}</p>
                <p><strong>Date Reported:</strong> ${data.dat_meld}</p>
                <p><strong>Gender:</strong> 
                    <select id="modal-gender" name="gender" onchange="changeGenderInModal(${data.id})">
                        <option value="M" ${gender === 'M채nnlich' ? 'selected' : ''}>M채nnlich</option>
                        <option value="W" ${gender === 'Weiblich' ? 'selected' : ''}>Weiblich</option>
                        <option value="N" ${gender === 'Nymphe' ? 'selected' : ''}>Nymphe</option>
                        <option value="O" ${gender === 'Ootheke' ? 'selected' : ''}>Ootheke</option>
                    </select>
                </p>
                <p><strong>Details:</strong> ${data.anm_melder}</p>`;
    }

    function changeGenderInModal(sightingId) {
        const gender = document.getElementById('modal-gender').value;
        changeGender(sightingId, gender);
    }

    function generateUserInfo(data) {
        // Convert user info into HTML string
        // Adjust fields according to your data structure
        return `<p><strong>User Name:</strong> ${data.user_name}</p>
                <p><strong>User Email:</strong> ${data.user_email}</p>`;
    }


    function generateLocationInfo(data) {
        // Convert location info into HTML string
        return `<p><strong>Location ID:</strong> ${data.fo_zuordnung}</p>
                <div id="map" style="height: 400px; width: 100%;"></div>`;
    }


    function closeModal() {
        // Hide modal
        document.getElementById('modal').classList.add('hidden');
    }

    function saveChanges() {
        // Save changes to report details
        // This will require additional setup based on how you want to edit the details
    }

    // Function to delete a sighting
    function deleteSighting(id) {
        let confirmDelete = confirm('Are you sure you want to delete this sighting? This action cannot be undone.');
        if (confirmDelete) {
            fetch('/delete_sighting/' + id, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    console.log(data);
                    // Remove the deleted card from the view
                    removeCardFromView(id);
                })
                .catch(error => console.error('Error:', error));
        }
    }

    // Function to remove a card from the view
    function removeCardFromView(id) {
        let card = document.querySelector(`[data - report - id= "${id}"]`);
        card.remove();
    }

    function exportCSV() {
        // Assuming there's an export function in your routes
        window.location.href = '/admin/export/csv/reported_sightings';
    }

    // Add a global variable to keep track of the toggle state
    let showApprovedSightings = false;

    // Function to toggle approved sightings based on the switch state
    function toggleApprovedSightings() {
        showApprovedSightings = !showApprovedSightings;
        filterSightings();
    }

    // Function to filter sightings based on the toggle state
    function filterSightings() {
        let cards = Array.from(document.getElementsByClassName('report-card'));

        cards.forEach(card => {
            let datBear = card.querySelector('p[data-dat-bear]');
            let isApproved = datBear !== null;

            if (showApprovedSightings) {
                card.style.display = isApproved ? '' : 'none';
            } else {
                card.style.display = isApproved ? 'none' : '';
            }
        });
    }

    // Call the filterSightings function initially to apply the default filter
    filterSightings();

</script>

{% endblock content %}